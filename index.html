<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Điều Khiển Fintech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .price-up { color: #22c55e; } /* green-500 */
        .price-down { color: #ef4444; } /* red-500 */
        .loader {
            border: 4px solid #374151; /* gray-700 */
            border-top: 4px solid #818cf8; /* indigo-400 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #030712; /* gray-950 */
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; /* gray-700 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563; /* gray-600 */
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-retrying { background-color: #f59e0b; animation: pulse 1.5s infinite; }
        .status-failed { background-color: #ef4444; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-row {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-300">

    <div class="container mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-violet-500">Bảng Điều Khiển Fintech</h1>
                <p class="text-gray-400 mt-1">Dữ liệu được cập nhật và phân tích theo thời gian thực.</p>
            </div>
            <div class="flex flex-col items-start md:items-end mt-4 md:mt-0 w-full md:w-auto">
                 <div id="apiStatus" class="flex items-center text-sm font-semibold mb-2 px-3 py-1 bg-gray-900/70 border border-gray-800 rounded-full">
                    <span id="statusDot" class="status-dot status-retrying"></span>
                    <span id="statusText">Đang kết nối...</span>
                </div>
                <div class="relative w-full md:w-80">
                    <input type="text" id="searchInput" placeholder="Tìm kiếm tiền điện tử..." class="w-full bg-gray-900 border border-gray-700/50 rounded-lg py-2.5 px-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-300">
                    <svg class="w-5 h-5 absolute right-3.5 top-1/2 -translate-y-1/2 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Crypto List -->
            <div class="lg:col-span-3 bg-gray-900/70 backdrop-blur-sm border border-gray-800/50 p-4 rounded-xl shadow-lg shadow-black/20">
                <h2 class="text-xl font-bold mb-4 text-white">Sàng lọc & Xếp hạng theo Tiềm năng Tăng trưởng</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b-2 border-gray-800 text-sm text-gray-400">
                            <tr>
                                <th class="px-6 py-4">#</th>
                                <th class="px-6 py-4">Tên</th>
                                <th class="px-6 py-4 text-center" title="Điểm tiềm năng tăng giá ngắn hạn dựa trên Đà tăng trưởng và Dòng tiền.">Điểm Tiềm Năng</th>
                                <th class="px-6 py-4 text-center">Tín Hiệu</th>
                                <th class="px-6 py-4 text-right">Giá</th>
                                <th class="px-6 py-4 text-right">24h %</th>
                                <th class="px-6 py-4 text-right" title="Sức mạnh tương đối so với Bitcoin. Chỉ số dương cho thấy hiệu suất tốt hơn BTC.">RS (vs BTC)</th>
                                <th class="px-6 py-4 text-right hidden md:table-cell">Vốn hóa thị trường</th>
                                <th class="px-6 py-4 text-right hidden lg:table-cell" title="Giá vào lệnh đề xuất, tính toán dựa trên cấu trúc giá 7 ngày.">Giá Entry</th>
                                <th class="px-6 py-4 text-right hidden lg:table-cell" title="Giá dừng lỗ đề xuất, đặt dưới mức hỗ trợ 7 ngày.">Stop Loss</th>
                                <th class="px-6 py-4 text-right hidden lg:table-cell" title="Giá chốt lời đề xuất, đặt tại vùng kháng cự 7 ngày.">Giá Chốt Lời</th>
                                <th class="px-6 py-4 text-right hidden lg:table-cell">Chu kỳ 7 ngày</th>
                            </tr>
                        </thead>
                        <tbody id="cryptoTableBody">
                            <tr>
                                <td colspan="12" class="text-center p-10">
                                    <div class="loader mx-auto"></div>
                                    <p class="mt-2 text-gray-400">Đang sàng lọc và xếp hạng...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Bot Analysis & Tools -->
            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Bot Analysis -->
                <div class="bg-gray-900/70 backdrop-blur-sm border border-gray-800/50 p-6 rounded-xl shadow-lg shadow-black/20">
                     <h2 class="text-xl font-bold mb-4 text-white flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-400" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 00-1-1v-.5a1.5 1.5 0 01-3 0V16a1 1 0 00-1-1H4a1 1 0 01-1-1v-3a1 1 0 011-1h.5a1.5 1.5 0 000-3H4a1 1 0 01-1-1V5a1 1 0 011-1h3a1 1 0 001-1v-.5z" /></svg>
                        Phân Tích Tổng Hợp Từ Bot
                    </h2>
                    <div id="botAnalysisSection" class="text-gray-300 space-y-4">
                        <p class="italic text-gray-500">Bot đang phân tích... Vui lòng chờ cập nhật dữ liệu.</p>
                    </div>
                </div>

                <!-- Tools -->
                <div class="bg-gray-900/70 backdrop-blur-sm border border-gray-800/50 p-6 rounded-xl shadow-lg shadow-black/20 h-fit">
                    <h2 class="text-xl font-bold mb-4 text-white">Công Cụ Phụ Trợ</h2>
                    <!-- Converter -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">Công cụ chuyển đổi</h3>
                        <div class="space-y-3">
                            <div>
                                <label for="fromCoin" class="text-sm text-gray-400">Từ</label>
                                <div class="flex items-center">
                                    <input type="number" id="fromAmount" value="1" class="w-1/3 bg-gray-800 border border-gray-700 rounded-l-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <select id="fromCoin" class="w-2/3 bg-gray-800 border-t border-b border-r border-gray-700 rounded-r-md p-2 focus:outline-none"></select>
                                </div>
                            </div>
                            <div>
                                 <label for="toCoin" class="text-sm text-gray-400">Đến</label>
                                <div class="flex items-center">
                                    <input type="text" id="toAmount" readonly class="w-1/3 bg-gray-950 border border-gray-700 rounded-l-md p-2">
                                    <select id="toCoin" class="w-2/3 bg-gray-800 border-t border-b border-r border-gray-700 rounded-r-md p-2 focus:outline-none"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Trending Coins -->
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">Xu Hướng Thị Trường</h3>
                        <div id="trendingList" class="space-y-3">
                            <div class="text-center p-4 text-gray-400">Đang tải...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>&copy; 2025 - Bot Fintech bởi Gemini. Nguồn dữ liệu: Hệ thống API dự phòng.</p>
        </footer>
    </div>
    
    <!-- Detailed Chart Modal -->
    <div id="chartModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-gray-900 border border-gray-800/50 rounded-xl shadow-2xl w-full max-w-4xl p-6 relative">
            <button id="closeModal" class="absolute top-4 right-5 text-gray-400 hover:text-white text-3xl font-bold transition-colors">&times;</button>
            <div id="modalHeader" class="flex items-center mb-2"></div>
            <p id="chartStatusText" class="text-sm text-gray-500 mb-2 h-5"></p>
            <div id="timeRangeSelector" class="mb-4 flex space-x-2">
                 <button data-days="1" class="time-range-btn bg-gray-800 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-all duration-200">24h</button>
                 <button data-days="7" class="time-range-btn bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-all duration-200">7d</button>
                 <button data-days="30" class="time-range-btn bg-gray-800 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-all duration-200">30d</button>
                 <button data-days="365" class="time-range-btn bg-gray-800 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-all duration-200">1y</button>
            </div>
            <div class="h-96 relative">
                <canvas id="detailedChartCanvas"></canvas>
                <div id="modalLoader" class="absolute inset-0 bg-gray-900/80 flex items-center justify-center rounded-xl hidden">
                    <div class="loader"></div>
                </div>
                <div id="modalError" class="absolute inset-0 bg-gray-900/90 flex-col items-center justify-center rounded-xl hidden p-4 text-center">
                    <p class="text-red-400 font-semibold text-lg">Lỗi!</p>
                    <p class="text-gray-300 mt-2">Không thể tải dữ liệu biểu đồ. Vui lòng đóng và thử lại sau.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const cryptoTableBody = document.getElementById('cryptoTableBody');
        const searchInput = document.getElementById('searchInput');
        const fromCoinSelect = document.getElementById('fromCoin');
        const toCoinSelect = document.getElementById('toCoin');
        const fromAmountInput = document.getElementById('fromAmount');
        const toAmountInput = document.getElementById('toAmount');
        const trendingList = document.getElementById('trendingList');
        const botAnalysisSection = document.getElementById('botAnalysisSection');
        const modal = document.getElementById('chartModal');
        const closeModalBtn = document.getElementById('closeModal');
        const modalHeader = document.getElementById('modalHeader');
        const modalLoader = document.getElementById('modalLoader');
        const modalError = document.getElementById('modalError');
        const detailedChartCanvas = document.getElementById('detailedChartCanvas');
        const detailedChartContext = detailedChartCanvas.getContext('2d');
        const timeRangeSelector = document.getElementById('timeRangeSelector');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const chartStatusText = document.getElementById('chartStatusText');

        // State
        let allCoinsData = [];
        let detailedChart;
        let currentModalCoinId = null;
        let chartCache = {};
        
        // --- API Failover System ---
        const API_SOURCES = [
            'https://api.coingecko.com/api/v3', 'https://api.coingecko.com/api/v3', 'https://api.coingecko.com/api/v3',
            'https://api.coingecko.com/api/v3', 'https://api.coingecko.com/api/v3', 'https://api.coingecko.com/api/v3',
            'https://api.coingecko.com/api/v3', 'https://api.coingecko.com/api/v3', 'https://api.coingecko.com/api/v3',
            'https://api.coingecko.com/api/v3'
        ];
        let currentApiSourceIndex = 0;

        // API Path getters
        const getApiUrl = (path) => `${API_SOURCES[currentApiSourceIndex]}${path}`;
        const API_PATHS = {
            markets: '/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=true&price_change_percentage=24h',
            btcPrice: '/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true',
            futures: '/derivatives/futures?include_tickers=unexpired',
            trending: '/search/trending',
            historical: (id, days) => `/coins/${id}/market_chart?vs_currency=usd&days=${days}`
        };
        
        const formatPrice = (num) => {
             if (num === null || num === undefined) return 'N/A';
             if (num < 1) return `$${num.toFixed(6)}`;
             return `$${num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        const formatNumber = (num, isPrice = true) => {
            if (num === null || num === undefined) return 'N/A';
            const prefix = isPrice ? '$' : '';
            if (num >= 1e12) return `${prefix}${(num / 1e12).toFixed(2)}T`;
            if (num >= 1e9) return `${prefix}${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `${prefix}${(num / 1e6).toFixed(2)}M`;
            if (isPrice) return formatPrice(num);
            return `${prefix}${num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        };

        const getPotentialScore = (coin) => {
            let score = 0;
            const change24h = coin.price_change_percentage_24h_in_currency || 0;
            const volRatio = coin.market_cap > 0 ? coin.total_volume / coin.market_cap : 0;
            if (change24h > 20) score += 50; else if (change24h > 10) score += 40; else if (change24h > 5) score += 30; else if (change24h > 2) score += 20; else if (change24h > 0) score += 10;
            if (volRatio > 0.5) score += 50; else if (volRatio > 0.3) score += 40; else if (volRatio > 0.2) score += 30; else if (volRatio > 0.1) score += 20; else if (volRatio > 0.05) score += 10;
            const sparkline = coin.sparkline_in_7d?.price;
            if (sparkline && sparkline.length > 1 && sparkline[sparkline.length - 1] > sparkline[0]) score += 10;
            const finalScore = Math.min(100, (score / 110) * 100);
            let colorClass = 'bg-gray-700';
            if (finalScore > 75) colorClass = 'bg-green-600/80'; else if (finalScore > 50) colorClass = 'bg-yellow-600/80'; else if (finalScore > 25) colorClass = 'bg-gray-600/80';
            return { score: finalScore, colorClass };
        };
        
        const calculateTradeSetup = (sparkline, currentPrice) => {
            if (!sparkline || sparkline.length < 2) return null;
            const low7d = Math.min(...sparkline);
            const high7d = Math.max(...sparkline);
            if (high7d === low7d) return null;
            const optimalEntry = low7d + (high7d - low7d) * 0.25;
            const takeProfit = high7d;
            const stopLoss = low7d * 0.99;
            if (currentPrice < optimalEntry * 1.20) {
                const risk = optimalEntry - stopLoss;
                const reward = takeProfit - optimalEntry;
                const rrRatio = risk > 0 ? (reward / risk) : 0;
                return { optimalEntry, takeProfit, stopLoss, rrRatio };
            }
            return null;
        };

        const generateSignalHTML = (coin) => {
            const volRatio = coin.market_cap > 0 ? coin.total_volume / coin.market_cap : 0;
            const absPriceChange = Math.abs(coin.price_change_percentage_24h_in_currency || 0);
            let signals = [];
            if (absPriceChange > 15 && volRatio > 0.30) {
                signals.push(`<svg title="Cảnh báo Biến động Mạnh: Rủi ro thanh lý các vị thế đòn bẩy." class="w-5 h-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`);
            } else if (coin.price_change_percentage_24h_in_currency > 2 && volRatio > 0.20) {
                signals.push(`<svg title="Tiềm năng tăng: Ghi nhận khối lượng giao dịch cao và giá tăng." xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>`);
            }
            if (coin.funding_rate && Math.abs(coin.funding_rate * 100) > 0.05) {
                const color = coin.funding_rate > 0 ? 'text-red-500' : 'text-green-500';
                const title = coin.funding_rate > 0 ? 'Funding Rate dương cao: Rủi ro đập long.' : 'Funding Rate âm sâu: Rủi ro ép bán.';
                signals.push(`<svg title="${title}" class="w-5 h-5 ${color}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 01-1.898-.632l4-12a1 1 0 011.265-.633zM5 7a1 1 0 011-1h9a1 1 0 110 2H6a1 1 0 01-1-1zm4 6a1 1 0 011-1h5a1 1 0 110 2h-5a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>`);
            }
            if (signals.length > 0) return `<div class="flex justify-center items-center space-x-2">${signals.join('')}</div>`;
            return '<span class="text-gray-600">-</span>';
        };

        const renderSparkline = (canvas, data) => {
            if (!canvas || !data || data.length === 0) return;
            const isUp = data[data.length - 1] > data[0];
            new Chart(canvas.getContext('2d'), {
                type: 'line', data: { labels: data.map((_, index) => index), datasets: [{ data, borderColor: isUp ? '#22c55e' : '#ef4444', borderWidth: 2.5, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        };

        const renderTable = (coins) => {
            const tableHtml = coins.map((coin, index) => {
                const priceChangeClass = coin.price_change_percentage_24h_in_currency >= 0 ? 'price-up' : 'price-down';
                const rsClass = coin.rs_24h_percentage >= 0 ? 'rs-strong' : 'rs-weak';
                
                return `
                    <tr class="border-b border-gray-800 hover:bg-gray-800/60 transition-all duration-300 ease-in-out fade-in-row" style="animation-delay: ${index * 0.03}s" data-id="${coin.id}">
                        <td class="px-6 py-4 text-gray-400">${index + 1}</td>
                        <td class="px-6 py-4"><div class="flex items-center"><img src="${coin.image}" alt="${coin.name}" class="w-8 h-8 mr-4 rounded-full"><div><p class="font-semibold text-white">${coin.name}</p><p class="text-sm text-gray-500">${coin.symbol.toUpperCase()}</p></div></div></td>
                        <td class="px-6 py-4 text-center"><span class="px-3 py-1 text-sm font-bold rounded-full text-white ${coin.potential.colorClass}">${coin.potential.score.toFixed(0)}</span></td>
                        <td class="px-6 py-4 text-center">${generateSignalHTML(coin)}</td>
                        <td class="px-6 py-4 text-right font-medium text-white">${formatNumber(coin.current_price)}</td>
                        <td class="px-6 py-4 text-right font-medium ${priceChangeClass}">${(coin.price_change_percentage_24h_in_currency || 0).toFixed(2)}%</td>
                        <td class="px-6 py-4 text-right font-medium ${rsClass}">${(coin.rs_24h_percentage || 0).toFixed(2)}%</td>
                        <td class="px-6 py-4 text-right text-gray-300 hidden md:table-cell">${formatNumber(coin.market_cap, false)}</td>
                        <td class="px-6 py-4 text-right font-mono text-cyan-400 hidden lg:table-cell">${coin.tradeSetup ? formatPrice(coin.tradeSetup.optimalEntry) : '<span class="text-gray-600">-</span>'}</td>
                        <td class="px-6 py-4 text-right font-mono text-orange-400 hidden lg:table-cell">${coin.tradeSetup ? formatPrice(coin.tradeSetup.stopLoss) : '<span class="text-gray-600">-</span>'}</td>
                        <td class="px-6 py-4 text-right font-mono text-green-400 hidden lg:table-cell">${coin.tradeSetup ? formatPrice(coin.tradeSetup.takeProfit) : '<span class="text-gray-600">-</span>'}</td>
                        <td class="px-6 py-4 text-right hidden lg:table-cell" style="width: 150px; height: 50px;"><canvas id="sparkline-${coin.id}"></canvas></td>
                    </tr>`;
            }).join('');
            
            cryptoTableBody.innerHTML = tableHtml || `<tr><td colspan="12" class="text-center p-10 text-gray-400">Không tìm thấy kết quả.</td></tr>`;
            
            coins.forEach(coin => {
                const canvas = document.getElementById(`sparkline-${coin.id}`);
                if (canvas && coin.sparkline_in_7d) {
                    renderSparkline(canvas, coin.sparkline_in_7d.price);
                }
            });
        };
        
        const renderTrendingList = (trendingData) => {
            trendingList.innerHTML = '';
            if (!trendingData.coins || trendingData.coins.length === 0) { trendingList.innerHTML = `<div class="text-center p-4 text-gray-400">Không có dữ liệu.</div>`; return; }
            trendingData.coins.forEach(coinData => {
                const coin = coinData.item;
                trendingList.innerHTML += `<div class="flex items-center justify-between p-2.5 bg-gray-800/50 rounded-lg transition-colors hover:bg-gray-800"><div class="flex items-center"><img src="${coin.small}" alt="${coin.name}" class="w-7 h-7 mr-3 rounded-full"><div><p class="font-semibold text-white">${coin.name}</p><p class="text-sm text-gray-500">${coin.symbol.toUpperCase()}</p></div></div><div class="text-right"><span class="text-sm text-gray-400">Rank #${coin.market_cap_rank}</span></div></div>`;
            });
        };
        
        const renderBotAnalysis = (coin) => {
             if (!coin) {
                 botAnalysisSection.innerHTML = `<p class="italic text-gray-500">Không có đồng tiền nào đủ tiêu chuẩn để phân tích.</p>`;
                 return;
             }
             let analysisHTML = `
                <div class="flex items-center mb-3"><img src="${coin.image}" class="w-8 h-8 mr-3 rounded-full" alt="${coin.name}"><h3 class="text-lg font-bold text-white">Phân tích: ${coin.name} (${coin.symbol.toUpperCase()})</h3></div>
                <p><b>${coin.name}</b> đang là ứng cử viên sáng giá nhất với <b>Điểm Tiềm Năng ${coin.potential.score.toFixed(0)}/100</b>. Dữ liệu cứng cho thấy:</p>
                <ul class="list-disc list-inside space-y-2 text-sm pl-2">
                    <li><b>Đà tăng trưởng mạnh:</b> Giá đã tăng <b>${(coin.price_change_percentage_24h_in_currency || 0).toFixed(2)}%</b> trong 24 giờ qua, vượt trội hơn Bitcoin <b>${(coin.rs_24h_percentage || 0).toFixed(2)}%</b>.</li>
                    <li><b>Dòng tiền vào tốt:</b> Tỷ lệ Khối lượng/Vốn hóa là <b>${((coin.total_volume / coin.market_cap) * 100).toFixed(2)}%</b>, cho thấy sự quan tâm lớn từ thị trường.</li>
                </ul>`;
            const { tradeSetup } = coin;
            if (tradeSetup) {
                analysisHTML += `
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <h4 class="font-semibold text-md text-white mb-2">Đề xuất Giao dịch Tối ưu:</h4>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <span class="text-gray-400">Giá Mua Tốt Nhất (Entry):</span><span class="font-mono text-right text-white">${formatPrice(tradeSetup.optimalEntry)}</span>
                            <span class="text-gray-400">Dừng Lỗ (SL):</span><span class="font-mono text-right text-red-400">${formatPrice(tradeSetup.stopLoss)}</span>
                            <span class="text-gray-400">Giá Bán Tốt Nhất (TP):</span><span class="font-mono text-right text-green-400">${formatPrice(tradeSetup.takeProfit)}</span>
                            <span class="text-gray-400">Tỷ lệ R:R:</span><span class="font-mono text-right font-bold ${tradeSetup.rrRatio >= 2 ? 'text-green-400' : 'text-yellow-400'}">${tradeSetup.rrRatio.toFixed(2)} : 1</span>
                        </div>
                    </div>`;
            }
            analysisHTML += `<p class="text-xs text-gray-500 mt-4"><b>Miễn trừ trách nhiệm:</b> Phân tích và đề xuất này là tổng hợp tự động từ dữ liệu thị trường và chỉ mang tính tham khảo, không phải lời khuyên đầu tư.</p>`;
            botAnalysisSection.innerHTML = analysisHTML;
        };

        const populateConverter = (coins) => {
            fromCoinSelect.innerHTML = ''; toCoinSelect.innerHTML = '';
            const usdOption = new Option('United States Dollar (USD)', 'usd');
            fromCoinSelect.add(usdOption.cloneNode(true)); toCoinSelect.add(usdOption);
            const sortedForConverter = [...coins].sort((a,b) => a.market_cap_rank - b.market_cap_rank);
            sortedForConverter.forEach(coin => {
                const option = new Option(`${coin.name} (${coin.symbol.toUpperCase()})`, coin.id);
                fromCoinSelect.add(option.cloneNode(true)); toCoinSelect.add(option);
            });
            fromCoinSelect.value = 'bitcoin'; toCoinSelect.value = 'usd';
            convertCurrency();
        };

        const convertCurrency = () => {
            const fromCoinId = fromCoinSelect.value;
            const toCoinId = toCoinSelect.value;
            const amount = parseFloat(fromAmountInput.value);
            if (isNaN(amount) || amount <= 0) { toAmountInput.value = '0.00'; return; }
            const getPrice = id => (id === 'usd') ? 1 : (allCoinsData.find(c => c.id === id)?.current_price || 0);
            const fromPrice = getPrice(fromCoinId);
            const toPrice = getPrice(toCoinId);
            if (fromPrice > 0 && toPrice > 0) {
                const result = (amount * fromPrice) / toPrice;
                toAmountInput.value = result.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 6 });
            } else { toAmountInput.value = 'Lỗi'; }
        };

        const fetchWithRetry = async (url, maxRetries = 3, initialDelay = 1000) => {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API returned status ${response.status}`);
                    return await response.json();
                } catch (error) {
                    attempt++;
                    console.error(`Fetch attempt ${attempt} for ${url} failed: ${error.message}`);
                    if (attempt >= maxRetries) throw error;
                    const delay = initialDelay * Math.pow(2, attempt - 1);
                    console.log(`Retrying in ${delay / 1000}s...`);
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        };

        const fetchAndDrawDetailedChart = async (coinId, days = 7) => {
            modalLoader.classList.remove('hidden');
            modalError.classList.add('hidden');
            chartStatusText.textContent = '';
            let fetchSuccessful = false;
            try {
                const data = await fetchWithRetry(getApiUrl(API_PATHS.historical(coinId, days)));
                if (!data || !data.prices || data.prices.length === 0) throw new Error("Dữ liệu biểu đồ không hợp lệ hoặc rỗng.");
                chartCache[`${coinId}-${days}`] = data.prices;
                fetchSuccessful = true;
            } catch (error) {
                console.error("Could not fetch detailed chart data after retries:", error);
                fetchSuccessful = false;
            } finally {
                const dataToDraw = chartCache[`${coinId}-${days}`];
                if (dataToDraw) {
                    detailedChartCanvas.style.visibility = 'visible';
                    modalError.classList.add('hidden');
                    if (detailedChart) detailedChart.destroy();
                    if (fetchSuccessful) {
                        chartStatusText.textContent = 'Dữ liệu được cập nhật.';
                        chartStatusText.className = 'text-sm text-green-500 mb-2 h-5';
                    } else {
                        chartStatusText.textContent = 'Lỗi cập nhật. Đang hiển thị dữ liệu cũ.';
                        chartStatusText.className = 'text-sm text-yellow-500 mb-2 h-5';
                    }
                    const isUp = dataToDraw.length > 1 && dataToDraw[dataToDraw.length - 1][1] > dataToDraw[0][1];
                    detailedChart = new Chart(detailedChartContext, {
                        type: 'line', data: { datasets: [{ label: 'Giá (USD)', data: dataToDraw.map(item => ({x: item[0], y: item[1]})), borderColor: isUp ? '#22c55e' : '#ef4444', borderWidth: 2, pointRadius: 0, tension: 0.1 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: days > 1 ? 'day' : 'hour' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af' } }, y: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af', callback: value => `$${value.toLocaleString()}` } } }, plugins: { legend: { display: false } } }
                    });
                } else {
                    if (detailedChart) detailedChart.destroy();
                    detailedChartCanvas.style.visibility = 'hidden';
                    modalError.classList.remove('hidden');
                    chartStatusText.textContent = '';
                }
                modalLoader.classList.add('hidden');
            }
        };

        const setApiStatus = (status, message) => {
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = message;
        };

        const fetchData = async () => {
            const apiResults = await Promise.allSettled([
                fetch(getApiUrl(API_PATHS.markets)), fetch(getApiUrl(API_PATHS.btcPrice)),
                fetch(getApiUrl(API_PATHS.futures)), fetch(getApiUrl(API_PATHS.trending))
            ]);
            if (apiResults[0].status !== 'fulfilled' || !apiResults[0].value.ok) throw new Error('Lỗi tải dữ liệu thị trường chính (Market Data).');
            if (apiResults[1].status !== 'fulfilled' || !apiResults[1].value.ok) throw new Error('Lỗi tải dữ liệu giá Bitcoin.');
            
            let rawCoinsData = await apiResults[0].value.json();
            const btcData = await apiResults[1].value.json();
            let futuresData = [];
            if (apiResults[2].status === 'fulfilled' && apiResults[2].value.ok) futuresData = await apiResults[2].value.json();
            else console.warn('Cảnh báo: Không thể tải dữ liệu phái sinh (Futures).');
            let trendingData = { coins: [] };
            if (apiResults[3].status === 'fulfilled' && apiResults[3].value.ok) trendingData = await apiResults[3].value.json();
            else console.warn('Cảnh báo: Không thể tải dữ liệu xu hướng (Trending).');

            const btcChange24h = btcData.bitcoin.usd_24h_change;
            const fundingRates = {};
            futuresData.forEach(f => { if (!fundingRates[f.symbol]) fundingRates[f.symbol] = f.funding_rate; });
            const newCoinsData = rawCoinsData.map(coin => ({
                ...coin,
                potential: getPotentialScore(coin),
                rs_24h_percentage: (coin.price_change_percentage_24h_in_currency || 0) - btcChange24h,
                funding_rate: fundingRates[coin.symbol.toUpperCase()],
                tradeSetup: calculateTradeSetup(coin.sparkline_in_7d?.price, coin.current_price)
            })).sort((a, b) => b.potential.score - a.potential.score);
            
            if(newCoinsData && newCoinsData.length > 0) allCoinsData = newCoinsData;
            renderTable(allCoinsData);
            populateConverter(rawCoinsData);
            renderTrendingList(trendingData);
            renderBotAnalysis(allCoinsData[0]);
        };

        const mainFetchLoop = async () => {
            let successful = false;
            const initialSourceIndex = currentApiSourceIndex;
            while(!successful) {
                try {
                    setApiStatus('status-retrying', `Đang cập nhật từ nguồn ${currentApiSourceIndex + 1}/${API_SOURCES.length}...`);
                    await fetchData();
                    setApiStatus('status-connected', `Đã kết nối (Nguồn ${currentApiSourceIndex + 1})`);
                    successful = true;
                    return;
                } catch (error) {
                    console.error(`Nguồn ${currentApiSourceIndex + 1} thất bại: ${error.message}`);
                    currentApiSourceIndex = (currentApiSourceIndex + 1) % API_SOURCES.length;
                    if (currentApiSourceIndex === initialSourceIndex) {
                        setApiStatus('status-failed', 'Tất cả các nguồn đều thất bại');
                        if (allCoinsData.length === 0) {
                            cryptoTableBody.innerHTML = `<tr><td colspan="12" class="text-center p-10 text-red-500"><strong>Lỗi Kết Nối:</strong> Không thể tải dữ liệu. Hệ thống sẽ tự thử lại sau 1 phút.</td></tr>`;
                        }
                        return;
                    }
                    await new Promise(res => setTimeout(res, 500));
                }
            }
        };

        // --- EVENT LISTENERS ---
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredCoins = allCoinsData.filter(c => c.name.toLowerCase().includes(searchTerm) || c.symbol.toLowerCase().includes(searchTerm));
            renderTable(filteredCoins);
        });
        
        fromCoinSelect.addEventListener('change', convertCurrency);
        toCoinSelect.addEventListener('change', convertCurrency);
        fromAmountInput.addEventListener('input', convertCurrency);
        
        cryptoTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row || !row.dataset.id) return;
            const coinId = row.dataset.id;
            currentModalCoinId = coinId; 
            const coin = allCoinsData.find(c => c.id === coinId);
            modalHeader.innerHTML = `<img src="${coin.image}" alt="${coin.name}" class="w-10 h-10 mr-4 rounded-full"><div><h2 class="text-2xl font-bold text-white">${coin.name}</h2><p class="text-gray-400">${coin.symbol.toUpperCase()}</p></div>`;
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-700'); btn.classList.add('bg-gray-800');
                if (btn.dataset.days === '7') { btn.classList.add('bg-indigo-700'); btn.classList.remove('bg-gray-800'); }
            });
            fetchAndDrawDetailedChart(coinId, 7);
            modal.classList.remove('hidden'); modal.classList.add('flex');
        });

        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden'); modal.classList.remove('flex');
            if (detailedChart) detailedChart.destroy();
            chartStatusText.textContent = '';
        });

        timeRangeSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('time-range-btn')) {
                const days = e.target.dataset.days;
                if (currentModalCoinId) fetchAndDrawDetailedChart(currentModalCoinId, days);
                document.querySelectorAll('.time-range-btn').forEach(btn => { btn.classList.remove('bg-indigo-700'); btn.classList.add('bg-gray-800'); });
                e.target.classList.add('bg-indigo-700'); e.target.classList.remove('bg-gray-800');
            }
        });

        // Initial fetch and set interval
        mainFetchLoop();
        setInterval(mainFetchLoop, 60000); // Update every 60 seconds

    </script>

</body>
</html>

