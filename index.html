<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bybit Browser Bot v4 ‚Äî Autopilot Live + Backtest</title>
  <style>
    :root{--bg:#0b1220;--card:#0e1726;--line:#1f2a44;--text:#e5e7eb;--muted:#93a4bf;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .wrap{max-width:1240px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:22px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-7{grid-column:span 7}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    label{display:block;color:var(--muted);font-size:12px;margin:6px 0 4px}
    input,select,button,textarea{width:100%;background:#0b1422;border:1px solid #1d2b4b;color:var(--text);border-radius:10px;padding:10px}
    input[type="checkbox"]{width:auto}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;background:#0b1422;border:1px solid #1d2b4b;color:var(--text)}
    .tiny{font-size:11px;color:#8ea0c2}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .ok{color:#86efac}.bad{color:#fecaca}.warn{color:#fde68a}
    #logLive,#logBack{height:210px;overflow:auto;background:#07101c;border:1px solid #14213b;border-radius:10px;padding:10px;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #14213b;padding:6px 8px;text-align:left}
    .tabs{display:flex;gap:8px;margin:8px 0 16px}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#0c1629;cursor:pointer}
    .tab.active{background:#13223b;border-color:#23406d}
    .tabview{display:none}.tabview.active{display:block}
    .btn{cursor:pointer}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Bybit Browser Bot v4 <span class="tiny">‚Äî Autopilot ‚Ä¢ Live Trading + Backtester</span></h1>
  <div class="tabs">
    <div class="tab active" data-tab="live">‚ö° Live Bot</div>
    <div class="tab" data-tab="back">‚õè Backtester</div>
    <div class="tab" data-tab="help">üß† Autopilot & Help</div>
  </div>

  <!-- LIVE TAB -->
  <section class="tabview active" id="tab-live">
    <div class="grid">
      <div class="card col-4">
        <b>1) API & B·∫£o m·∫≠t</b>
        <label>API Key</label><input id="apiKey" placeholder="BYBITxxxx"/>
        <label>API Secret</label><input id="apiSecret" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        <label>Passphrase m√£ ho√°</label><input id="passphrase" type="password" placeholder="v√≠ d·ª•: batman-2002"/>
        <div class="row" style="margin-top:8px">
          <button id="saveKeys" class="btn">L∆∞u</button>
          <button id="loadKeys" class="btn">Gi·∫£i m√£ & n·∫°p</button>
          <button id="clearKeys" class="btn">Xo√°</button>
        </div>
        <div class="row" style="margin-top:8px">
          <label class="pill"><input id="useTestnet" type="checkbox" checked> Testnet</label>
          <label class="pill"><input id="simMode" type="checkbox"> SIM mode</label>
          <label class="pill"><input id="autoRun" type="checkbox"> Auto‚Äërun khi m·ªü trang</label>
        </div>
        <div class="tiny" style="margin-top:8px">‚ö†Ô∏è API ch·ªâ b·∫≠t Spot trade, t·∫Øt Withdraw. Secret ƒë∆∞·ª£c AES‚ÄëGCM ho√° b·∫±ng passphrase v√† l∆∞u localStorage.</div>
        <div class="tiny warn" id="corsWarn" style="display:none;margin-top:6px">N·∫øu l·ªói CORS ‚Üí d√πng Testnet ho·∫∑c Proxy ri√™ng.</div>
      </div>

      <div class="card col-8">
        <b>2) Chi·∫øn l∆∞·ª£c & t·ª± ƒë·ªông ho√° (Live)</b>
        <div class="grid" style="margin-top:6px">
          <div class="col-3"><label>USDT m·ªói l·ªánh</label><input id="orderQuote" type="number" min="5" step="0.1" value="8"/></div>
          <div class="col-3"><label>Khung n·∫øn</label><select id="tf"><option value="1">1m</option><option value="3">3m</option><option value="5" selected>5m</option><option value="15">15m</option></select></div>
          <div class="col-3"><label>Recv Window (ms)</label><input id="recvWindow" type="number" value="5000"/></div>
          <div class="col-3"><label>Proxy (tu·ª≥ ch·ªçn)</label><input id="proxy" placeholder="https://your-worker.workers.dev"/></div>
          <div class="col-12 row">
            <label class="pill"><input id="autoMode" type="checkbox"> Mua t·ª± ƒë·ªông</label>
            <label class="pill"><input id="btcFilter" type="checkbox" checked> BTC 5m uptrend</label>
            <label class="pill"><input id="useTrailing" type="checkbox" checked> Trailing SL</label>
            <label class="pill"><input id="useBreakeven" type="checkbox" checked> BE‚Äëlock</label>
            <label class="pill"><input id="useOCOEmu" type="checkbox" checked> OCO m√¥ ph·ªèng</label>
          </div>
          <div class="col-12"><label>Danh s√°ch symbol (CSV)</label><input id="symbolList" placeholder="ƒê·ªÉ tr·ªëng = bot t·ª± ch·ªçn top xu h∆∞·ªõng"/></div>
          <div class="col-3"><label>Min ƒëi·ªÉm t√≠n hi·ªáu (>=)</label><input id="minScore" type="number" value="5"/></div>
          <div class="col-3"><label>Time‚Äëstop (ph√∫t)</label><input id="timeStopMin" type="number" value="15"/></div>
          <div class="col-3"><label>Max thua li√™n ti·∫øp/ng√†y</label><input id="maxLossDay" type="number" value="2"/></div>
          <div class="col-3"><label>Chu k·ª≥ qu√©t (s)</label><input id="scanSec" type="number" value="20"/></div>
        </div>
        <div class="grid" style="margin-top:8px">
          <div class="col-12" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px">
            <div><div class="tiny">Tr·∫°ng th√°i</div><div id="status" class="ok">Nh√†n r·ªói</div></div>
            <div><div class="tiny">Theo d√µi</div><div id="watching">‚Äî</div></div>
            <div><div class="tiny">T√≠n hi·ªáu</div><div id="signal">‚Äî</div></div>
            <div><div class="tiny">C·∫≠p nh·∫≠t</div><div id="lastUpdate">‚Äî</div></div>
            <div><div class="tiny">L·ªó/Ng√†y</div><div id="lossStreak">0</div></div>
            <div><div class="tiny">PnL/Ng√†y</div><div id="pnlDay">0.00</div></div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="start" class="btn">‚ñ∂ B·∫Øt ƒë·∫ßu</button>
          <button id="stop" class="btn">‚ñ† D·ª´ng</button>
          <button id="resetDay" class="btn">‚ü≤ Reset phi√™n</button>
          <label class="pill" style="margin-left:auto;"><input id="autoResetStart" type="checkbox" checked> T·ª± reset phi√™n khi b·∫Øt ƒë·∫ßu</label>
        </div>
      </div>

      <div class="card col-12">
        <b>Nh·∫≠t k√Ω Live</b>
        <div id="logLive"></div>
      </div>
      <div class="card col-12">
        <b>Journal & Hi·ªáu su·∫•t (Live)</b>
        <table id="journalLive"><thead><tr><th>Th·ªùi gian</th><th>Symbol</th><th>Entry</th><th>TP</th><th>SL</th><th>Exit</th><th>KQ/PnL</th><th>Ghi ch√∫</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <section class="tabview" id="tab-back">
    <div class="grid">
      <div class="card col-5">
        <b>Backtester ‚Äì C·∫•u h√¨nh d·ªØ li·ªáu</b>
        <div class="grid" style="margin-top:6px">
          <div class="col-4"><label>Khung n·∫øn</label><select id="B_tf"><option value="1">1m</option><option value="3">3m</option><option value="5" selected>5m</option><option value="15">15m</option></select></div>
          <div class="col-4"><label>Nh√¨n l·∫°i (s·ªë n·∫øn)</label><input id="B_lookback" type="number" value="1000" /></div>
          <div class="col-4"><label>Top coin theo turnover</label><input id="B_topN" type="number" value="12" /></div>
          <div class="col-12"><label>Danh s√°ch symbol (CSV, ƒë·ªÉ tr·ªëng = l·∫•y top)</label><input id="B_symbolList" placeholder="BTCUSDT,ETHUSDT,SOLUSDT"/></div>
        </div>
        <div class="row" style="margin-top:8px">
          <label class="pill"><input id="B_btcFilter" type="checkbox" checked> BTC 5m uptrend</label>
          <label class="pill"><input id="B_pessimistic" type="checkbox" checked> ∆Øu ti√™n gi·∫£ ƒë·ªãnh x·∫•u (SL tr∆∞·ªõc)</label>
        </div>
      </div>
      <div class="card col-7">
        <b>Backtester ‚Äì Chi·∫øn l∆∞·ª£c & ph√≠</b>
        <div class="grid" style="margin-top:6px">
          <div class="col-3"><label>Min ƒëi·ªÉm</label><input id="B_minScore" type="number" value="5"/></div>
          <div class="col-3"><label>TP = k√óATR</label><input id="B_tpK" type="number" step="0.1" value="1.2"/></div>
          <div class="col-3"><label>SL = k√óATR</label><input id="B_slK" type="number" step="0.1" value="0.8"/></div>
          <div class="col-3"><label>Time‚Äëstop (ph√∫t)</label><input id="B_timeStopMin" type="number" value="15"/></div>
          <div class="col-3"><label>USDT/Trade</label><input id="B_quote" type="number" step="0.1" value="8"/></div>
          <div class="col-3"><label>Ph√≠ taker (%)</label><input id="B_feePct" type="number" step="0.01" value="0.10"/></div>
          <div class="col-3"><label>Slippage (bps)</label><input id="B_slipBps" type="number" step="0.1" value="2"/></div>
          <div class="col-3 row"><label class="pill"><input id="B_useBreakeven" type="checkbox" checked> BE‚Äëlock</label></div>
          <div class="col-9 row"><label class="pill"><input id="B_useTrailing" type="checkbox" checked> Trailing sau TP</label></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="B_run" class="btn">‚ñ∂ Backtest</button>
          <button id="B_grid" class="btn">‚õè Grid Search</button>
          <button id="autopilot" class="btn">üöÄ Autopilot: Optimize ‚Üí Start</button>
        </div>
      </div>
      <div class="card col-12"><div id="logBack"></div></div>
      <div class="card col-12"><div id="B_summary" class="mono"></div></div>
      <div class="card col-12">
        <b>Journal (Backtest)</b>
        <table id="journalBack"><thead><tr><th>Th·ªùi gian</th><th>Symbol</th><th>Entry</th><th>TP</th><th>SL</th><th>Exit</th><th>PnL($)</th><th>Ghi ch√∫</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card col-12">
        <b>Result by Symbol (Backtest)</b>
        <table id="bySymBack"><thead><tr><th>Symbol</th><th>Trades</th><th>Win %</th><th>PnL($)</th><th>Avg R</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <section class="tabview" id="tab-help">
    <div class="card col-12">
      <b>H∆∞·ªõng d·∫´n & Autopilot</b>
      <ul>
        <li><b>Autopilot (üöÄ):</b> Nh·∫•n n√∫t "Autopilot: Optimize ‚Üí Start" ·ªü tab Backtester. Bot s·∫Ω:
          <ol>
            <li>Ch·∫°y <b>Grid Search</b> ƒë·ªÉ t√¨m c·∫∑p TP/SL √ó ATR t·ªët nh·∫•t.</li>
            <li>T·ª± ƒë·ªông <b>copy</b> c√°c tham s·ªë t·ªëi ∆∞u sang tab Live Bot.</li>
            <li>N·∫øu c√≥ API ƒë√£ l∆∞u, bot s·∫Ω <b>h·ªèi passphrase</b>, gi·∫£i m√£ v√† n·∫°p. N·∫øu th·∫•t b·∫°i ho·∫∑c kh√¥ng c√≥ API, bot s·∫Ω t·ª± ƒë·ªông ch·∫°y ·ªü ch·∫ø ƒë·ªô <b>SIM mode</b>.</li>
            <li>B·∫≠t <b>Mua t·ª± ƒë·ªông</b> v√† <b>kh·ªüi ƒë·ªông</b> bot. (N·∫øu kh√¥ng ·ªü SIM mode, bot s·∫Ω t·ª± k·∫øt n·ªëi WebSocket private ƒë·ªÉ theo d√µi l·ªánh kh·ªõp nhanh h∆°n).</li>
          </ol>
        </li>
        <li><b>Reset phi√™n:</b> T√πy ch·ªçn "T·ª± reset phi√™n khi b·∫Øt ƒë·∫ßu" (m·∫∑c ƒë·ªãnh b·∫≠t) s·∫Ω x√≥a PnL v√† loss streak ng√†y c≈© m·ªói khi b·∫°n nh·∫•n Start.</li>
        <li><b>Quy tr√¨nh th·ªß c√¥ng:</b> 1Ô∏è‚É£ Backtest ‚Üí 2Ô∏è‚É£ Tinh ch·ªânh c·∫•u h√¨nh Live ‚Üí 3Ô∏è‚É£ N·∫°p API (n·∫øu trade th·∫≠t) ‚Üí 4Ô∏è‚É£ Start.</li>
        <li>‚ö†Ô∏è <b>L∆∞u √Ω:</b> Lu√¥n ch·∫°y SIM/Testnet tr∆∞·ªõc. Kh√¥ng d√πng API c√≥ quy·ªÅn withdraw. N·∫øu v∆∞·ªõng CORS, d√πng proxy ri√™ng (Cloudflare Worker).</li>
      </ul>
    </div>
  </section>
</div>

<script>
const $ = id => document.getElementById(id); 
// ============ TAB SWITCH ============
const tabs=[...document.querySelectorAll('.tab')]; const views={live:$('tab-live'), back:$('tab-back'), help:$('tab-help')};
tabs.forEach(t=>t.onclick=()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); Object.values(views).forEach(v=>v.classList.remove('active')); views[t.dataset.tab].classList.add('active'); });

// ============ UTIL & CRYPTO ============
const enc=new TextEncoder(), dec=new TextDecoder();
const logLive=(m,l='info')=>{const t=new Date().toLocaleTimeString(),c=l==='error'?'bad':l==='warn'?'warn':'ok',e=$('logLive');e.innerHTML+=`<div class="${c} mono">[${t}] ${m}</div>`;e.scrollTop=e.scrollHeight;};
const logBack=(m,l='info')=>{const t=new Date().toLocaleTimeString(),c=l==='error'?'bad':l==='warn'?'warn':'ok',e=$('logBack');e.innerHTML+=`<div class="${c} mono">[${t}] ${m}</div>`;e.scrollTop=e.scrollHeight;};
async function kdf(p,s){const b=await crypto.subtle.importKey('raw',enc.encode(p),{name:'PBKDF2'},!1,['deriveKey']);return crypto.subtle.deriveKey({name:'PBKDF2',salt:s,iterations:120000,hash:'SHA-256'},b,{name:'AES-GCM',length:256},!1,['encrypt','decrypt']);}
async function seal(p,t){const i=crypto.getRandomValues(new Uint8Array(12)),s=crypto.getRandomValues(new Uint8Array(16)),k=await kdf(p,s),c=await crypto.subtle.encrypt({name:'AES-GCM',iv:i},k,enc.encode(t));return{iv:btoa(String.fromCharCode(...i)),s:btoa(String.fromCharCode(...s)),d:btoa(String.fromCharCode(...new Uint8Array(c)))};}
async function open(p,b){const i=Uint8Array.from(atob(b.iv),c=>c.charCodeAt(0)),s=Uint8Array.from(atob(b.s),c=>c.charCodeAt(0)),d=Uint8Array.from(atob(b.d),c=>c.charCodeAt(0)),k=await kdf(p,s);return dec.decode(await crypto.subtle.decrypt({name:'AES-GCM',iv:i},k,d));}
async function hmac(s,m){const k=await crypto.subtle.importKey('raw',enc.encode(s),{name:'HMAC',hash:'SHA-256'},!1,['sign']),g=await crypto.subtle.sign('HMAC',k,enc.encode(m));return Array.from(new Uint8Array(g)).map(b=>b.toString(16).padStart(2,'0')).join('');}

// ============ SHARED INDICATORS ============
function sma(a,n){if(a.length<n)return null;let s=0;for(let i=a.length-n;i<a.length;i++)s+=a[i];return s/n;}
function rsi(v,p=14){if(v.length<=p)return null;let g=0,l=0;for(let i=1;i<=p;i++){const d=v[i]-v[i-1];d>=0?g+=d:l-=d;}let ag=g/p,al=l/p,o=100-100/(1+ag/(al||1e-12));for(let i=p+1;i<v.length;i++){const d=v[i]-v[i-1],G=d>0?d:0,L=d<0?-d:0;ag=(ag*(p-1)+G)/p;al=(al*(p-1)+L)/p;o=100-100/(1+ag/(al||1e-12));}return o;}
function trArr(H,L,C){const o=[];let pc=C[0];for(let i=0;i<H.length;i++)o.push(Math.max(H[i]-L[i],Math.abs(H[i]-pc),Math.abs(L[i]-pc))),pc=C[i];return o;}
function median(a){const b=[...a].sort((x,y)=>x-y),m=Math.floor(b.length/2);return b.length%2?b[m]:(b[m-1]+b[m])/2;}
function pullbackScore(kl){const C=kl.map(k=>k.c),H=kl.map(k=>k.h),L=kl.map(k=>k.l),ema20=sma(C,20),ema50=sma(C,50);if(ema20==null||ema50==null)return{score:0};const last=C[C.length-1],prev=C[C.length-2],r=rsi(C,14)||0;let s=0;ema20>ema50&&(s+=2);last>ema20&&(s+=1);r>52&&(s+=1);(prev<ema20&&last>ema20)&&(s+=2);const tr=trArr(H,L,C).slice(-30),atr=median(tr);return{score:s,atr,last};}

// ============ LIVE BOT ============
const Store={saveKeys:async()=>{const k=$('apiKey').value.trim(),s=$('apiSecret').value.trim(),p=$('passphrase').value;if(!k||!s||!p)return logLive('Thi·∫øu API/Secret/Pass','error');const b=await seal(p,s);localStorage.setItem('bb4_key',k);localStorage.setItem('bb4_sec',JSON.stringify(b));localStorage.setItem('bb4_testnet',$('useTestnet').checked?'1':'0');logLive('ƒê√£ m√£ ho√° & l∆∞u API','ok');},loadKeys:async()=>{try{const p=$('passphrase').value;if(!p)return logLive('Vui l√≤ng nh·∫≠p passphrase','warn');const k=localStorage.getItem('bb4_key'),b=localStorage.getItem('bb4_sec');if(!k||!b)return logLive('Ch∆∞a c√≥ kho√° ƒë√£ l∆∞u','warn');const s=await open(p,JSON.parse(b));$('apiKey').value=k;$('apiSecret').value=s;$('useTestnet').checked=localStorage.getItem('bb4_testnet')==='1';logLive('ƒê√£ gi·∫£i m√£ API Secret','ok');return!0;}catch(e){return logLive('Gi·∫£i m√£ th·∫•t b·∫°i: '+e.message,'error'),!1;}},clear:()=>{localStorage.removeItem('bb4_key');localStorage.removeItem('bb4_sec');logLive('ƒê√£ xo√° API kh·ªèi tr√¨nh duy·ªát','ok');},saveCfg:()=>{const c={q:+$('orderQuote').value,tf:$('tf').value,rw:+$('recvWindow').value,p:$('proxy').value.trim(),am:$('autoMode').checked,bf:$('btcFilter').checked,ut:$('useTrailing').checked,ub:$('useBreakeven').checked,uo:$('useOCOEmu').checked,sl:$('symbolList').value,ms:+$('minScore').value,ts:+$('timeStopMin').value,ml:+$('maxLossDay').value,ss:+$('scanSec').value,ar:$('autoRun').checked,sm:$('simMode').checked,ars:$('autoResetStart').checked};localStorage.setItem('bb4_cfg',JSON.stringify(c));},loadCfg:()=>{const j=localStorage.getItem('bb4_cfg');if(!j)return;const c=JSON.parse(j);$('orderQuote').value=c.q??8;$('tf').value=c.tf??'5';$('recvWindow').value=c.rw??5000;$('proxy').value=c.p??'';$('autoMode').checked=!!c.am;$('btcFilter').checked=!!c.bf;$('useTrailing').checked=!!c.ut;$('useBreakeven').checked=!!c.ub;$('useOCOEmu').checked=!!c.uo;$('symbolList').value=c.sl??'';$('minScore').value=c.ms??5;$('timeStopMin').value=c.ts??15;$('maxLossDay').value=c.ml??2;$('scanSec').value=c.ss??20;$('autoRun').checked=!!c.ar;$('simMode').checked=!!c.sm;$('autoResetStart').checked=c.ars===void 0||!!c.ars;}};
$('saveKeys').onclick=Store.saveKeys;$('loadKeys').onclick=Store.loadKeys;$('clearKeys').onclick=Store.clear;
['orderQuote', 'tf', 'recvWindow', 'proxy', 'autoMode', 'btcFilter', 'useTrailing', 'useBreakeven', 'useOCOEmu', 'symbolList', 'minScore', 'timeStopMin', 'maxLossDay', 'scanSec', 'autoRun', 'simMode', 'autoResetStart'].forEach(id => $(id)?.addEventListener('change', Store.saveCfg));
Store.loadCfg();

let srvOff=0,ws=null;
const api={time:async()=>{try{const r=await fetch(api.buildUrl('/v5/market/time')),j=await r.json();srvOff=Number(j.result.timeNano)/1e6-Date.now();logLive(`Œît=${Math.round(srvOff)}ms`,'ok');}catch(e){logLive('L·ªói ƒë·ªìng b·ªô th·ªùi gian','warn');}},sign:async(m,p,q={},b=null)=>{const k=$('apiKey').value.trim(),s=$('apiSecret').value.trim();if(!k||!s)throw new Error('Thi·∫øu API');const w=String(+$('recvWindow').value||5000),t=String(Date.now()+srvOff),o=m==='POST'&&b?JSON.stringify(b):'',u=m==='GET'?`${t}${k}${w}${new URLSearchParams(q)}`:`${t}${k}${w}${o}`,g=await hmac(s,u),h={'X-BAPI-API-KEY':k,'X-BAPI-TIMESTAMP':t,'X-BAPI-RECV-WINDOW':w,'X-BAPI-SIGN':g,'Content-Type':'application/json'},r=await fetch(api.buildUrl(p,m==='GET'?q:{}),{method:m,headers:h,body:o||void 0});r.status===403&&!$('proxy').value.trim()&&($('corsWarn').style.display='block');const d=await r.json().catch(()=>({retCode:-1,retMsg:'Non-JSON'}));if(!r.ok||d.retCode!==0)throw new Error(`HTTP ${r.status} ‚Äì ${d.retMsg||'ERR'} (${d.retCode})`);return d.result;},pub:async(p,q={})=>{const r=await fetch(api.buildUrl(p,q));r.status===403&&!$('proxy').value.trim()&&($('corsWarn').style.display='block');return r.json();},klines:async(s,i='5',l=200)=>{const j=await api.pub('/v5/market/kline',{category:'spot',symbol:s,interval:i,limit:l});if(j.retCode!==0)throw new Error(j.retMsg);return j.result.list.map(r=>({t:+r[0],o:+r[1],h:+r[2],l:+r[3],c:+r[4],v:+r[5]})).reverse();},tickers:async()=>{const j=await api.pub('/v5/market/tickers',{category:'spot'});if(j.retCode!==0)throw new Error(j.retMsg);return j.result.list;},instruments:async s=>{const j=await api.pub('/v5/market/instruments-info',{category:'spot',symbol:s});if(j.retCode!==0)throw new Error(j.retMsg);return j.result.list[0];},getUniverse:async()=>{const l=await api.tickers(),a=l.filter(x=>x.symbol.endsWith('USDT')).map(x=>({symbol:x.symbol,chg24:+x.price24hPcnt||0,vol24:+x.turnover24h||0})).filter(x=>x.vol24>1e7);return a.sort((a,b)=>b.chg24-a.chg24),a.slice(0,40).map(x=>x.symbol);},btcOk:async()=>{try{const k=await api.klines('BTCUSDT',$('tf').value,100),C=k.map(k=>k.c);return sma(C,20)>sma(C,50)&&rsi(C,14)>48;}catch{return!0;}},buy:async(s,q)=>api.sign('POST','/v5/order/create',{},{category:'spot',symbol:s,side:'Buy',orderType:'Market',marketUnit:'quoteCoin',qty:String(q),orderLinkId:'buy_'+s+'_'+Date.now()}),sl:async(s,y,p)=>api.sign('POST','/v5/order/create',{},{category:'spot',symbol:s,side:'Sell',orderType:'Market',qty:String(y),triggerPrice:String(p),triggerDirection:2}),tp:async(s,y,p)=>api.sign('POST','/v5/order/create',{},{category:'spot',symbol:s,side:'Sell',orderType:'Market',qty:String(y),triggerPrice:String(p),triggerDirection:1}),cancelAll:async s=>{try{await api.sign('POST','/v5/order/cancel-all',{},{category:'spot',symbol:s});}catch(e){logLive('Cancel all fail: '+e.message,'warn');}},wsUrl:()=>$('useTestnet').checked?'wss://stream-testnet.bybit.com/v5/private':'wss://stream.bybit.com/v5/private',buildUrl:(p,q)=>{const x=$('proxy').value.trim(),u=($('useTestnet').checked?'https://api-testnet.bybit.com':'https://api.bybit.com')+p+(q&&Object.keys(q).length?'?'+new URLSearchParams(q):'');return(x?x.replace(/\/$/,'')+'/':'')+u;}};

const journal={today:()=>new Date().toISOString().slice(0,10),get:()=>{const j=localStorage.getItem('bb4_state');return j?JSON.parse(j):{date:journal.today(),loss:0,pnl:0,trades:[]};},set:s=>{localStorage.setItem('bb4_state',JSON.stringify(s));$('lossStreak').textContent=s.loss;$('pnlDay').textContent=s.pnl.toFixed(2);journal.render(s.trades);},ensureToday:()=>{let s=journal.get();s.date!==journal.today()&&(s={date:journal.today(),loss:0,pnl:0,trades:[]},journal.set(s));},push:t=>{const s=journal.get();s.trades.unshift(t);t.pnl!==void 0&&(s.pnl+=t.pnl);t.pnl<0?s.loss+=1:t.pnl>0&&(s.loss=0);journal.set(s);},render:l=>{const b=$('journalLive').querySelector('tbody');b.innerHTML='';l.slice(0,200).forEach(r=>{const e=document.createElement('tr');e.innerHTML=`<td>${new Date(r.ts).toLocaleTimeString()}</td><td>${r.sym}</td><td>${r.entry?.toFixed?.(6)||'-'}</td><td>${r.tp?.toFixed?.(6)||'-'}</td><td>${r.sl?.toFixed?.(6)||'-'}</td><td>${r.exit?.toFixed?.(6)||'-'}</td><td>${r.pnl?.toFixed?.(2)||r.note||'-'}</td><td>${r.note||''}</td>`,b.appendChild(e);});}};
$('resetDay').onclick=()=>{journal.set({date:journal.today(),loss:0,pnl:0,trades:[]});logLive('ƒê√£ reset phi√™n','ok');};
journal.ensureToday();journal.set(journal.get());

let run=false,tmr=null,inPos=false,cur={};
function calcTPSL(e,a,t,s){const p=e+t*a,l=Math.max(e-s*a,1e-9);return{tp:+p.toFixed(8),sl:+l.toFixed(8),rr:+(p-e)/(e-l||1e-9)};}
async function step(){$('lastUpdate').textContent=new Date().toLocaleTimeString();journal.ensureToday();const s=journal.get();if(s.loss>=+$('maxLossDay').value)return $('status').textContent='T·∫°m d·ª´ng (circuit breaker)';try{if(inPos)return;let syms=$('symbolList').value.trim()?$('symbolList').value.toUpperCase().split(',').map(s=>s.trim()).filter(Boolean):await api.getUniverse();$('watching').textContent=syms.slice(0,6).join(',')+(syms.length>6?' ...':'');if($('btcFilter').checked){const ok=await api.btcOk();if(!ok)return logLive('BTC trend x·∫•u ‚Üí b·ªè l∆∞·ª£t','warn');}let best=null;for(const sym of syms)try{const kl=await api.klines(sym,$('tf').value,200),s=pullbackScore(kl);(!best||s.score>best.meta?.score)&&(best={sym,meta:s,last:s.last,atr:s.atr});}catch(e){}
$('signal').textContent=best?`${best.sym} ‚Ä¢ ƒëi·ªÉm ${best.meta.score} ‚Ä¢ RSI ${best.meta.rsi?.toFixed(1)||'-'}`:'‚Äî';if(!$('autoMode').checked||!best||best.meta.score<+$('minScore').value)return;const tpsl=calcTPSL(best.last,best.atr||best.last*.005,1.2,.8);if(tpsl.rr<1.2)return logLive(`B·ªè: R:R ${tpsl.rr}<1.2`,'warn');const q=+$('orderQuote').value||8,{qty}=await api.instruments(best.sym).then(info=>{const ls=info.lotSizeFilter||{},mA=+ls.minOrderAmt||5,sS=+ls.qtyStep||1/10**(+ls.basePrecision||8),pP=+ls.pricePrecision||8;let qt=Math.max(q,mA),y=qt/best.last;y=Math.floor(y/sS)*sS;return{qty:+y.toFixed(8)};});if(qty<=0)return logLive('Kh√¥ng t√≠nh ƒë∆∞·ª£c qty h·ª£p l·ªá','warn');inPos=!0;cur={sym:best.sym,entry:best.last,tp:tpsl.tp,sl:tpsl.sl,ts:Date.now(),qty,quote:q,atr:best.atr||best.last*.005};if($('simMode').checked)return $('status').textContent='[SIM] Trong v·ªã th·∫ø',logLive(`[SIM] BUY ${best.sym} ~${best.last} TP=${tpsl.tp} SL=${tpsl.sl}`,'ok'),simMonitor();$('status').textContent='Mua...';const b=await api.buy(best.sym,q);logLive(`ƒê√£ BUY market ${best.sym} (id=${b.orderId})`,'ok');$('status').textContent='Trong v·ªã th·∫ø';await api.cancelAll(best.sym);await api.tp(best.sym,qty,tpsl.tp);await api.sl(best.sym,qty,tpsl.sl);logLive('ƒê√£ ƒë·∫∑t OCO m√¥ ph·ªèng (TP/SL)','ok');monitor();}catch(e){logLive('L·ªói step: '+(e.message||e),'error'),inPos=!1;}}

let monTmr=null;
async function monitor(){if(ws)return;clearInterval(monTmr);const tS=+$('timeStopMin').value*60*1e3,st=Date.now();monTmr=setInterval(async()=>{try{const kl=await api.klines(cur.sym,'1',2),px=kl[kl.length-1].c;if(Date.now()-st>tS){const p=(px-cur.entry)*cur.qty;logLive('Time‚Äëstop ‚Üí Market Exit','warn');journal.push({ts:Date.now(),sym:cur.sym,entry:cur.entry,tp:cur.tp,sl:cur.sl,exit:px,pnl:p,note:'Time-stop'});await api.buy(cur.sym,cur.quote);await gracefulExit();return;}
let nS=cur.sl,m=!1;if($('useBreakeven').checked&&!cur.beLocked&&px>=cur.entry+.6*cur.atr){nS=Math.max(cur.sl,cur.entry-.1*cur.atr);if(nS>cur.sl)cur.beLocked=!0,logLive(`BE‚Äëlock: n√¢ng SL ‚Üí ${nS.toFixed(6)}`,'ok'),m=!0;}
if($('useTrailing').checked&&px>=cur.tp){nS=Math.max(nS,px-.6*cur.atr);if(nS>cur.sl)logLive(`Trailing SL ‚Üí ${nS.toFixed(6)}`,'ok'),m=!0;}
if(m)cur.sl=nS,await api.cancelAll(cur.sym),await api.tp(cur.sym,cur.qty,cur.tp),await api.sl(cur.sym,cur.qty,cur.sl);}catch(e){logLive('L·ªói theo d√µi: '+e.message,'warn');}},5e3);}
async function gracefulExit(){clearInterval(monTmr);inPos=!1;$('status').textContent='Nh√†n r·ªói';if(cur.sym) await api.cancelAll(cur.sym);cur={};ws&&(ws.close(),ws=null);}
let simTmr=null;function simMonitor(){clearInterval(simTmr);const tS=+$('timeStopMin').value*60*1e3,st=Date.now();let p=cur.entry;simTmr=setInterval(()=>{const d=(Math.random()-.48)*cur.atr*.2;p+=d;const checkExit=(e,n)=>{clearInterval(simTmr);inPos=!1;$('status').textContent='Nh√†n r·ªói';const l=(e-cur.entry)*cur.qty;logLive(`[SIM] ${n} @ ${e.toFixed(6)}`,'ok');journal.push({ts:Date.now(),sym:cur.sym,entry:cur.entry,tp:cur.tp,sl:cur.sl,exit:e,pnl:l,note:'SIM '+n});};if(p>=cur.tp)return checkExit(cur.tp,'TP hit');if(p<=cur.sl)return checkExit(cur.sl,'SL hit');if(Date.now()-st>tS)return checkExit(p,'Time-stop');if($('useBreakeven').checked&&!cur.beLocked&&p>=cur.entry+.6*cur.atr)cur.sl=Math.max(cur.sl,cur.entry-.1*cur.atr),cur.beLocked=!0;if($('useTrailing').checked&&p>cur.tp)cur.sl=Math.max(cur.sl,p-.6*cur.atr);},1500);}

async function startBot(){if(run)return;$('autoResetStart').checked&&$('resetDay').click();run=!0;await api.time();if(!$('simMode').checked){const t=Date.now()+srvOff+5e3,s=await hmac('GET/realtime'+t,$('apiSecret').value.trim());ws=new WebSocket(api.wsUrl());ws.onopen=()=>{ws.send(JSON.stringify({op:'auth',args:[$('apiKey').value.trim(),t,s]}));ws.send(JSON.stringify({op:'subscribe',args:['order']}));logLive('Private WS connected.','ok');};ws.onmessage=e=>{const j=JSON.parse(e.data);if(j.topic==='order'){const d=j.data[0];if(cur && cur.sym && d.symbol===cur.sym&&d.side==='Sell'&&d.orderStatus==='Filled'){const p=(+d.avgPrice-cur.entry)*cur.qty;logLive(`‚úÖ WS: TP/SL kh·ªõp @ ${d.avgPrice} ‚Üí PnL: ${p.toFixed(2)}`,'ok');journal.push({ts:Date.now(),sym:cur.sym,entry:cur.entry,tp:cur.tp,sl:cur.sl,exit:+d.avgPrice,pnl:p,note:'WS Exit'});gracefulExit();}}};ws.onerror=e=>logLive('WS Error','error');ws.onclose=()=>logLive('WS Closed','warn');}
const sec=+$('scanSec').value||20;tmr=setInterval(step,sec*1e3);step();$('status').textContent='ƒêang qu√©t...';logLive('B·∫Øt ƒë·∫ßu','ok');}
function stopBot(){run=!1;clearInterval(tmr);gracefulExit();$('status').textContent='Nh√†n r·ªói';logLive('D·ª´ng','warn');}
$('start').onclick=startBot;$('stop').onclick=stopBot;window.addEventListener('load',()=>{if($('autoRun').checked)$('start').click();});

// ============ BACKTESTER ============
const Backtester={api:{pub:async(p,q={})=>{const u='https://api.bybit.com'+p+(Object.keys(q).length?'?'+new URLSearchParams(q):''),r=await fetch(u);return r.json();},tickers:async()=>{const j=await Backtester.api.pub('/v5/market/tickers',{category:'spot'});if(j.retCode!==0)throw new Error(j.retMsg);return j.result.list;},klines:async(s,i='5',l=1e3)=>{const j=await Backtester.api.pub('/v5/market/kline',{category:'spot',symbol:s,interval:i,limit:l});if(j.retCode!==0)throw new Error(j.retMsg);return j.result.list.map(r=>({t:+r[0],o:+r[1],h:+r[2],l:+r[3],c:+r[4],v:+r[5]})).reverse();},getUniverse:async n=>{const l=await Backtester.api.tickers(),a=l.filter(x=>x.symbol.endsWith('USDT')).map(x=>({symbol:x.symbol,chg24:+x.price24hPcnt||0,vol24:+x.turnover24h||0})).filter(x=>x.vol24>1e7);return a.sort((a,b)=>b.chg24-a.chg24),a.slice(0,n).map(x=>x.symbol);},btcOk:async t=>{try{const k=await Backtester.api.klines('BTCUSDT',t,200),C=k.map(k=>k.c);return sma(C,20)>sma(C,50)&&rsi(C,14)>48;}catch(e){return!0;}}},exitInBar:(b,e,t,s,p)=>{const hT=b.h>=t,hS=b.l<=s;return hT&&hS?{hit:p?'sl':'tp'}:hT?{hit:'tp'}:hS?{hit:'sl'}:{hit:null};},render:r=>{const s=r.summary;$('B_summary').innerHTML=`T·ªïng l·ªánh: ${s.trades} | Win%: ${s.winRate}% | PnL($): ${s.pnl} | MaxDD($): ${s.maxDD} | Avg R: ${s.avgR} | PF: ${s.pf}`;const tb=$('journalBack').querySelector('tbody');tb.innerHTML='';r.trades.slice(-200).reverse().forEach(t=>{const e=document.createElement('tr');e.innerHTML=`<td>${new Date(t.ts).toLocaleString()}</td><td>${t.sym}</td><td>${t.entry.toFixed(6)}</td><td>${t.tp.toFixed(6)}</td><td>${t.sl.toFixed(6)}</td><td>${t.exit?.toFixed(6)||'-'}</td><td>${t.pnl.toFixed(2)}</td><td>${t.note||''}</td>`,tb.appendChild(e);});const sb=$('bySymBack').querySelector('tbody');sb.innerHTML='';Object.entries(s.bySym).sort((a,b)=>b[1].p-a[1].p).forEach(([sym,v])=>{const e=document.createElement('tr'),w=v.tr?(v.w/v.tr*100).toFixed(1):'0.0',a=v.rc?(v.r/v.rc).toFixed(2):'0.00';e.innerHTML=`<td>${sym}</td><td>${v.tr}</td><td>${w}%</td><td>${v.p.toFixed(2)}</td><td>${a}</td>`,sb.appendChild(e);});},summarize:d=>{const n=d.length;let w=0,p=0,m=0,e=0,k=0,rS=0,rC=0;const by={};for(const t of d){p+=t.pnl,e+=t.pnl,k=Math.max(k,e),m=Math.min(m,e-k);const r=(t.exit-t.entry)/(t.entry-t.sl);isFinite(r)&&(rS+=r,rC++);const y=t.sym;by[y]=by[y]||{tr:0,w:0,p:0,r:0,rc:0},by[y].tr++,by[y].p+=t.pnl,t.pnl>0&&by[y].w++,isFinite(r)&&(by[y].r+=r,by[y].rc++),t.pnl>0&&w++;}const wR=n?w/n*100:0,aR=rC?rS/rC:0,lS=d.filter(t=>t.pnl<0).reduce((a,b)=>a+b.pnl,0),pF=p>0?d.filter(t=>t.pnl>0).reduce((a,b)=>a+b.pnl,0)/Math.abs(lS||1):0;return{trades:n,winRate:+wR.toFixed(1),pnl:+p.toFixed(2),maxDD:+m.toFixed(2),avgR:+aR.toFixed(2),pf:+pF.toFixed(2),bySym:by};},run:async()=>{logBack('B·∫Øt ƒë·∫ßu backtest','ok');$('B_summary').textContent='ƒêang ch·∫°y...';const c={tf:$('B_tf').value,L:+$('B_lookback').value,ms:+$('B_minScore').value,tk:+$('B_tpK').value,sk:+$('B_slK').value,ts:+$('B_timeStopMin').value,q:+$('B_quote').value,f:+$('B_feePct').value/100,p:+$('B_slipBps').value/1e4,be:$('B_useBreakeven').checked,tr:$('B_useTrailing').checked,pe:$('B_pessimistic').checked};let syms=$('B_symbolList').value.trim()?$('B_symbolList').value.toUpperCase().split(',').map(s=>s.trim()).filter(Boolean):await Backtester.api.getUniverse(+$('B_topN').value);if($('B_btcFilter').checked){const ok=await Backtester.api.btcOk(c.tf);if(!ok)return logBack('BTC filter: trend x·∫•u','warn'),Backtester.render({trades:[],summary:{trades:0,winRate:0,pnl:0,maxDD:0,avgR:0,pf:0,bySym:{}}});}
let trades=[];for(const s of syms)try{const kl=await Backtester.api.klines(s,c.tf,c.L);if(kl.length<200)continue;let inPos=!1,e=0,t=0,l=0,a=0,eI=0;for(let i=60;i<kl.length;i++){const h=kl.slice(0,i);if(!inPos){const sc=pullbackScore(h);if(sc.score>=c.ms){e=kl[i].o,a=sc.atr||e*.005,t=e+c.tk*a,l=Math.max(1e-9,e-c.sk*a),eI=i,inPos=!0;continue;}}else{const b=kl[i];if(c.be){const bl=e+.6*a;b.h>=bl&&(l=Math.max(l,e-.1*a));}if(c.tr&&b.h>=t){const tS=b.c-.6*a;tS>l&&(l=tS);}const hit=Backtester.exitInBar(b,e,t,l,c.pe);if(hit.hit){const x=hit.hit==='tp'?t:l,g=(x-e)/e*c.q,f=(c.f+c.p)*2*c.q;trades.push({ts:b.t,sym:s,entry:e,tp:t,sl:l,exit:x,pnl:+(g-f).toFixed(4),note:hit.hit.toUpperCase()});inPos=!1;continue;}const bH=i-eI,mPB=+c.tf.replace('m','');if(bH*mPB>=c.ts){const x=b.c,g=(x-e)/e*c.q,f=(c.f+c.p)*2*c.q;trades.push({ts:b.t,sym:s,entry:e,tp:t,sl:l,exit:x,pnl:+(g-f).toFixed(4),note:'TIME'});inPos=!1;continue;}}}}catch(e){logBack(`L·ªói backtest ${s}: ${e.message}`,'warn');}
const sum=Backtester.summarize(trades);Backtester.render({trades,summary:sum});logBack('Ho√†n t·∫•t backtest','ok');return sum;},grid:async()=>{const bTP=+$('B_tpK').value,bSL=+$('B_slK').value,tps=[bTP-.2,bTP,bTP+.2].filter(x=>x>.2),sls=[bSL-.2,bSL,bSL+.2].filter(x=>x>.2);let best=null;for(const t of tps)for(const s of sls){$('B_tpK').value=t;$('B_slK').value=s;logBack(`Test tp=${t.toFixed(1)} sl=${s.toFixed(1)}`,'warn');const res=await Backtester.run();if(res){const p=res.pnl;(!best||p>best.pnl)&&(best={tp:t,sl:s,pnl:p});}} if(best) {$('B_summary').textContent=`Best ‚Üí TP=${best.tp.toFixed(1)}√óATR, SL=${best.sl.toFixed(1)}√óATR | PnL‚âà${best.pnl}`;} return best;}};
$('B_run').onclick=Backtester.run;$('B_grid').onclick=Backtester.grid;
$('autopilot').onclick=async()=>{logBack('Autopilot starting...','ok');const best=await Backtester.grid();if(best){$('B_tpK').value=best.tp;$('B_slK').value=best.sl;$('minScore').value=$('B_minScore').value;$('timeStopMin').value=$('B_timeStopMin').value;logLive(`Autopilot: ƒê√£ copy c·∫•u h√¨nh t·ªëi ∆∞u t·ª´ backtest. (TP=${best.tp}, SL=${best.sl})`,'ok');}
const hasApi=localStorage.getItem('bb4_key');let pass,apiLoaded=!1;hasApi&&(pass=prompt('Nh·∫≠p passphrase ƒë·ªÉ ch·∫°y Live/Testnet (b·ªè qua ƒë·ªÉ ch·∫°y SIM)'));if(pass){$('passphrase').value=pass;apiLoaded=await Store.loadKeys();}
if(!apiLoaded){logLive('Autopilot: Kh√¥ng c√≥ API/passphrase. Ch·∫°y SIM mode.','warn');$('simMode').checked=!0;}$('autoMode').checked=!0;startBot();tabs[0].click();};
</script>
</body>
</html>

