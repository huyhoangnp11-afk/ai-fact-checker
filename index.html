<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit Trading Bot</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CryptoJS for API signature generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .log-area { font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-break: break-all; }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .regime-trend { background-color: #166534; color: #dcfce7; }
        .regime-range { background-color: #1e40af; color: #dbeafe; }
        .regime-squeeze { background-color: #9a3412; color: #ffedd5; }
        .regime-micro-grid { background-color: #581c87; color: #f3e8ff; }
        .regime-none { background-color: #4b5563; color: #d1d5db; }
        /* Simple toggle switch styles */
        .toggle-checkbox:checked { right: 0; border-color: #68d391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68d391; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-7xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        
        <header class="text-center">
            <h1 class="text-3xl font-bold text-white">Bybit Trading Bot</h1>
            <p class="text-gray-400 mt-2">Giao dịch tự động và quản lý tài khoản Bybit của bạn.</p>
        </header>

        <!-- Security Warning -->
        <div class="bg-red-900 border-l-4 border-red-500 text-red-100 p-4 rounded-lg" role="alert">
            <p class="font-bold">Cảnh báo bảo mật quan trọng</p>
            <p>API Key và Secret Key của bạn chỉ được lưu trữ cục bộ trong trình duyệt (localStorage). KHÔNG chia sẻ tệp này hoặc sử dụng trên máy tính công cộng.</p>
        </div>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Left Column: Settings & Account -->
            <div class="bg-gray-700/50 p-6 rounded-xl space-y-6">
                 <div class="flex items-center justify-between border-b border-gray-600 pb-3">
                    <h2 class="text-xl font-semibold">Cài đặt API</h2>
                    <span id="apiStatus" class="text-xs font-medium px-2.5 py-1 rounded-full">&nbsp;</span>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-300 mb-1">API Key</label>
                        <input type="password" id="apiKey" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="apiSecret" class="block text-sm font-medium text-gray-300 mb-1">API Secret</label>
                        <input type="password" id="apiSecret" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                     <div class="flex items-center justify-between">
                        <button id="saveApi" class="w-2/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">Lưu API Key</button>
                        <div class="flex items-center space-x-2 text-sm">
                           <label for="showApiKeys" class="text-gray-400">Hiện Keys</label>
                           <input type="checkbox" id="showApiKeys" class="form-checkbox h-5 w-5 text-blue-500 bg-gray-900 border-gray-600 rounded focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div class="pt-6 border-t border-gray-600">
                    <h2 class="text-xl font-semibold mb-3">Thông tin tài khoản</h2>
                    <button id="getBalance" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition mb-4 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Lấy số dư (Tài khoản Unified)</button>
                    <div id="balanceInfo" class="bg-gray-900 p-4 rounded-lg text-sm min-h-[80px]">
                        Nhấn nút trên để xem số dư...
                    </div>
                </div>
            </div>

            <!-- Right Column: Trading -->
            <div class="bg-gray-700/50 p-6 rounded-xl space-y-6">
                <h2 class="text-xl font-semibold border-b border-gray-600 pb-3">Đặt lệnh giao dịch (Spot)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="symbol" class="block text-sm font-medium text-gray-300 mb-1">Cặp giao dịch (ví dụ: BTCUSDT)</label>
                        <input type="text" id="symbol" value="BTCUSDT" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="qty" class="block text-sm font-medium text-gray-300 mb-1">Số lượng</label>
                        <input type="number" id="qty" placeholder="0.01" step="0.001" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="buyBtn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Mua (Market)</button>
                        <button id="sellBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Bán (Market)</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- DCA Bot Section -->
        <div class="bg-gray-700/50 p-6 rounded-xl mt-6">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-3 mb-4">Bot DCA (Trung bình giá)</h2>
            <div class="bg-blue-900 border-l-4 border-blue-500 text-blue-100 p-4 rounded-lg mb-4" role="alert">
                <p><strong class="font-bold">Lưu ý:</strong> Bot DCA sẽ chỉ hoạt động khi tab trình duyệt này đang mở. Nếu bạn đóng tab, bot sẽ dừng lại.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="dcaSymbol" class="block text-sm font-medium text-gray-300 mb-1">Cặp giao dịch</label>
                    <input type="text" id="dcaSymbol" value="BTCUSDT" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="dcaAmount" class="block text-sm font-medium text-gray-300 mb-1">Số tiền mỗi lần mua (USDT)</label>
                    <input type="number" id="dcaAmount" placeholder="10" step="1" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="dcaFrequency" class="block text-sm font-medium text-gray-300 mb-1">Tần suất</label>
                    <select id="dcaFrequency" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="3600000">Mỗi giờ</option>
                        <option value="86400000" selected>Mỗi ngày</option>
                        <option value="604800000">Mỗi tuần</option>
                        <option value="60000">Mỗi phút (thử nghiệm)</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="startDcaBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Bắt đầu Bot DCA</button>
                <button id="stopDcaBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300" disabled>Dừng Bot DCA</button>
            </div>
            <div id="dcaStatus" class="mt-4 bg-gray-900 p-3 rounded-lg text-sm text-center">Bot DCA đang không hoạt động.</div>
        </div>

        <!-- Market Scanner Section -->
        <div class="bg-gray-700/50 p-6 rounded-xl mt-6">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-3 mb-4">Kế Hoạch Giao Dịch Tự Động (V3.4.0)</h2>
            <div class="bg-blue-900 border-l-4 border-blue-500 text-blue-100 p-4 rounded-lg mb-4" role="alert">
                <p><strong class="font-bold">Cách Hoạt Động:</strong> Nhấn "Bắt đầu Quét". Nếu bật "Tự động Trade", bot sẽ tự vào lệnh Market Mua theo kế hoạch tìm được.</p>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-1">
                    <label for="scannerCapital" class="block text-sm font-medium text-gray-300 mb-1">Tổng vốn cho Scanner (USD)</label>
                    <input type="number" id="scannerCapital" value="100" step="10" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div class="md:col-span-1 flex items-end pb-1">
                     <label for="autoTradeToggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="autoTradeToggle" class="sr-only peer">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full peer-checked:bg-green-600"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform transform peer-checked:translate-x-full"></div>
                        </div>
                        <span class="ml-3 text-sm font-medium text-gray-300">Tự động Trade</span>
                    </label>
                </div>
                <div class="md:col-span-2 grid grid-cols-2 gap-4">
                    <button id="startScannerBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Bắt đầu Quét</button>
                    <button id="stopScannerBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300" disabled>Dừng Quét</button>
                </div>
            </div>
            <div id="scannerStatus" class="mt-4 bg-gray-900 p-3 rounded-lg text-sm text-center">Công cụ quét đang không hoạt động.</div>
            
            <!-- Trading Plan Cards Container -->
            <div id="scannerResults" class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Trading Plan Cards will be populated here -->
            </div>
        </div>

        <!-- Log Area -->
        <div class="bg-gray-900/70 p-4 rounded-xl mt-6">
            <h2 class="text-lg font-semibold mb-2">Nhật ký hoạt động</h2>
            <div id="log" class="log-area bg-black h-48 overflow-y-auto p-3 rounded-lg text-xs text-gray-400"></div>
        </div>

    </div>

    <!-- Loading Spinner Modal -->
    <div id="loaderModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
            <p id="loaderText" class="mt-4 text-white text-lg font-semibold">Đang xử lý...</p>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const ui = {
                apiKeyInput: document.getElementById('apiKey'),
                apiSecretInput: document.getElementById('apiSecret'),
                saveApiBtn: document.getElementById('saveApi'),
                showApiKeysCheckbox: document.getElementById('showApiKeys'),
                apiStatus: document.getElementById('apiStatus'),
                getBalanceBtn: document.getElementById('getBalance'),
                balanceInfoDiv: document.getElementById('balanceInfo'),
                symbolInput: document.getElementById('symbol'),
                qtyInput: document.getElementById('qty'),
                buyBtn: document.getElementById('buyBtn'),
                sellBtn: document.getElementById('sellBtn'),
                logDiv: document.getElementById('log'),
                loaderModal: document.getElementById('loaderModal'),
                loaderText: document.getElementById('loaderText'),
                dca: {
                    symbol: document.getElementById('dcaSymbol'),
                    amount: document.getElementById('dcaAmount'),
                    frequency: document.getElementById('dcaFrequency'),
                    startBtn: document.getElementById('startDcaBtn'),
                    stopBtn: document.getElementById('stopDcaBtn'),
                    status: document.getElementById('dcaStatus'),
                },
                scanner: {
                    capital: document.getElementById('scannerCapital'),
                    autoTradeToggle: document.getElementById('autoTradeToggle'),
                    startBtn: document.getElementById('startScannerBtn'),
                    stopBtn: document.getElementById('stopScannerBtn'),
                    status: document.getElementById('scannerStatus'),
                    results: document.getElementById('scannerResults'),
                }
            };

            // --- State Management ---
            const state = {
                apiKey: '',
                apiSecret: '',
                dcaIntervalId: null,
                scannerIntervalId: null,
                isScanning: false,
                apiKeysValid: false,
                autoTradeEnabled: false,
                recentlyTradedSymbols: [],
            };

            // --- Constants ---
            const CONSTANTS = {
                BYBIT_API_URL: 'https://api.bybit.com',
                RECV_WINDOW: '10000', // Adjusted as per your recommendation
                SCANNER_INTERVAL_MS: 120000, // 2 minutes
            };
            
            // --- Technical Analysis & Scanner Logic Configuration ---
            const CONFIG = {
                MIN_TURNOVER_24H: 500000,
                KLINE_INTERVAL: '15',
                KLINE_LIMIT: 200,
                MIN_KLINE_LENGTH: 50,
                ATR_PCT_MIN_BASE: 0.12,
                ATR_PCT_MAX_BASE: 6.0,
                SPREAD_BPS_MIN: 15,
                SPREAD_BPS_MAX: 25,
                ADX_TREND_THRESHOLD: 22,
                BBW_SQUEEZE_THRESHOLD: 0.035,
                RAOS_THRESHOLDS: { range: 0.66, trend: 0.68, squeeze: 0.72 },
                EDGE_COEFFICIENTS: {
                    range:   { tp1: 0.65, tp2: 0.35, tp1ATR: 1.2, tp2ATR: 2.2 },
                    squeeze: { tp1: 0.55, tp2: 0.45, tp1ATR: 1.5, tp2ATR: 3.0 },
                    trend:   { tp1: 0.55, tp2: 0.45, tp1ATR: 1.6, tp2ATR: 3.2 }
                },
                CAPITAL_ALLOCATION_PCT: [0.028, 0.028, 0.024]
            };

            // --- Core Functions ---
            const showLoader = (text = 'Đang xử lý...') => {
                ui.loaderText.textContent = text;
                ui.loaderModal.classList.remove('hidden');
            };
            const hideLoader = () => ui.loaderModal.classList.add('hidden');

            function logMessage(message, isError = false) {
                const timestamp = new Date().toLocaleString();
                const colorClass = isError ? 'text-red-400' : 'text-green-400';
                ui.logDiv.innerHTML += `<p class="${colorClass}">[${timestamp}] ${message}</p>`;
                ui.logDiv.scrollTop = ui.logDiv.scrollHeight;
            }

            async function getServerTimestampMs() {
                const r = await fetch(`${CONSTANTS.BYBIT_API_URL}/v5/market/time`);
                const j = await r.json();
                if (j.retCode !== 0) throw new Error("Could not sync Bybit server time.");
                const nsStr = j.result?.timeNano;
                let tsMs;
                if (nsStr) {
                    tsMs = (BigInt(nsStr) / 1000000n) - 200n;
                } else {
                    const secStr = j.result?.timeSecond ?? `${Math.floor(Date.now()/1000)}`;
                    tsMs = (BigInt(secStr) * 1000n) - 200n;
                }
                return tsMs.toString();
            }

            async function bybitRequest(endpoint, method, params = {}, isPublic = false) {
                const isValidationCall = endpoint === '/v5/user/query-api';
                if (!isPublic && !state.apiKeysValid && !isValidationCall) {
                    logMessage('API Keys không hợp lệ hoặc chưa được lưu.', true);
                    return null;
                }
                const headers = { 'Content-Type': 'application/json' };
                let url = `${CONSTANTS.BYBIT_API_URL}${endpoint}`;
                let body;
                if (!isPublic) {
                    const timestamp = await getServerTimestampMs();
                    const paramStr = method === 'POST' ? JSON.stringify(params) : new URLSearchParams(params).toString();
                    const signStr = timestamp + state.apiKey + CONSTANTS.RECV_WINDOW + paramStr;
                    const signature = CryptoJS.HmacSHA256(signStr, state.apiSecret).toString(CryptoJS.enc.Hex);
                    Object.assign(headers, {
                        'X-BAPI-API-KEY': state.apiKey, 'X-BAPI-TIMESTAMP': timestamp,
                        'X-BAPI-RECV-WINDOW': CONSTANTS.RECV_WINDOW, 'X-BAPI-SIGN': signature,
                    });
                    if (method === 'GET' && paramStr) url += `?${paramStr}`;
                    if (method === 'POST') body = paramStr;
                } else {
                     if (Object.keys(params).length > 0) url += `?${new URLSearchParams(params)}`;
                }
                try {
                    const response = await fetch(url, { method, headers, body });
                    const data = await response.json();
                    if (data.retCode !== 0) {
                        if (data.retMsg.includes("Not supported symbols") || data.retMsg.includes("Instrument not found")) return null;
                        throw new Error(`Bybit API Error: ${data.retMsg} (Code: ${data.retCode})`);
                    }
                    return data.result;
                } catch (error) {
                    logMessage(error.message, true);
                    return null;
                }
            }
            
            function updateApiStatus(isValid) {
                state.apiKeysValid = isValid;
                if (isValid) {
                    ui.apiStatus.textContent = 'Hợp lệ';
                    ui.apiStatus.className = 'text-xs font-medium px-2.5 py-1 rounded-full bg-green-900 text-green-300';
                    [ui.getBalanceBtn, ui.buyBtn, ui.sellBtn, ui.dca.startBtn, ui.scanner.startBtn].forEach(btn => btn.disabled = false);
                } else {
                    ui.apiStatus.textContent = 'Không hợp lệ';
                    ui.apiStatus.className = 'text-xs font-medium px-2.5 py-1 rounded-full bg-red-900 text-red-300';
                    [ui.getBalanceBtn, ui.buyBtn, ui.sellBtn, ui.dca.startBtn, ui.scanner.startBtn].forEach(btn => btn.disabled = true);
                }
            }

            function updateDcaStatus(message) { ui.dca.status.textContent = message; }
            function updateScannerStatus(message) { ui.scanner.status.textContent = message; }

            async function checkApiKeys() {
                if (!state.apiKey || !state.apiSecret) {
                    updateApiStatus(false); return;
                }
                showLoader('Đang xác thực API Keys...');
                const result = await bybitRequest('/v5/user/query-api', 'GET', {});
                hideLoader();
                updateApiStatus(!!result);
                if (!!result) logMessage('Xác thực API Key thành công.');
            }

            function loadAndCheckApiKeys() {
                state.apiKey = localStorage.getItem('bybitApiKey') || '';
                state.apiSecret = localStorage.getItem('bybitApiSecret') || '';
                ui.apiKeyInput.value = state.apiKey;
                ui.apiSecretInput.value = state.apiSecret;
                if (state.apiKey && state.apiSecret) {
                    checkApiKeys();
                } else {
                    updateApiStatus(false);
                }
            }
            
            async function fetchWalletBalance() {
                showLoader('Đang lấy số dư...');
                const result = await bybitRequest('/v5/account/wallet-balance', 'GET', { accountType: 'UNIFIED' });
                hideLoader();
                if (result?.list?.[0]) {
                    const account = result.list[0];
                    let balanceHTML = `<p><strong>Tổng vốn (USD):</strong> ${parseFloat(account.totalEquity).toFixed(2)}</p><p><strong>Số dư khả dụng (USD):</strong> ${parseFloat(account.totalAvailableBalance).toFixed(2)}</p><hr class="my-2 border-gray-600"><ul class="space-y-1 max-h-40 overflow-y-auto">`;
                    account.coin.forEach(c => { if (parseFloat(c.walletBalance) > 0) balanceHTML += `<li><strong>${c.coin}:</strong> ${parseFloat(c.walletBalance).toFixed(6)}</li>`; });
                    balanceHTML += '</ul>';
                    ui.balanceInfoDiv.innerHTML = balanceHTML;
                } else {
                    ui.balanceInfoDiv.textContent = "Không thể lấy dữ liệu số dư.";
                }
            }

            async function placeOrder(orderParams) {
                if (!orderParams.symbol || !orderParams.qty || parseFloat(orderParams.qty) <= 0) {
                    logMessage('Thông tin lệnh không hợp lệ.', true); return null;
                }
                showLoader(`Đang đặt lệnh ${orderParams.side} ${orderParams.symbol}...`);
                const result = await bybitRequest('/v5/order/create', 'POST', orderParams);
                hideLoader();
                if (result?.orderId) {
                    logMessage(`Đặt lệnh ${orderParams.side} ${orderParams.symbol} thành công! Order ID: ${result.orderId}`);
                    return result;
                }
                return null;
            }
            
            function stopDcaBot() {
                if (state.dcaIntervalId) {
                    clearInterval(state.dcaIntervalId);
                    state.dcaIntervalId = null;
                    logMessage("Bot DCA đã dừng.");
                    updateDcaStatus("Bot DCA đã dừng.");
                    ui.dca.startBtn.disabled = false;
                    ui.dca.stopBtn.disabled = true;
                    [ui.dca.symbol, ui.dca.amount, ui.dca.frequency].forEach(el => el.disabled = false);
                }
            }
            
            function startDcaBot() {
                const symbol = ui.dca.symbol.value.trim().toUpperCase();
                const amount = ui.dca.amount.value.trim();
                const frequencyMs = parseInt(ui.dca.frequency.value, 10);
                if (!symbol || !amount || parseFloat(amount) <= 0) {
                    logMessage("Vui lòng nhập thông tin hợp lệ cho bot DCA.", true); return;
                }
                logMessage(`Bắt đầu bot DCA: Mua ${amount} USDT cho ${symbol} mỗi ${ui.dca.frequency.options[ui.dca.frequency.selectedIndex].text}.`);
                ui.dca.startBtn.disabled = true;
                ui.dca.stopBtn.disabled = false;
                [ui.dca.symbol, ui.dca.amount, ui.dca.frequency].forEach(el => el.disabled = true);
                const executeDcaPurchase = () => {
                    const nextRunTime = new Date(Date.now() + frequencyMs).toLocaleString();
                    logMessage(`[DCA] Thực hiện mua ${amount} USDT cho ${symbol}...`);
                    updateDcaStatus(`Đang hoạt động. Lần mua tiếp theo: ${nextRunTime}`);
                    placeOrder({ category: 'spot', symbol, side: 'Buy', orderType: 'Market', qty: amount, marketUnit: 'quoteCoin' });
                };
                executeDcaPurchase();
                state.dcaIntervalId = setInterval(executeDcaPurchase, frequencyMs);
            }
            
            // --- Scanner Bot Logic ---
            const TA = {
                ema: (d, p) => { if (!d || d.length < p) return []; const k = 2 / (p + 1); let e = [d[0]]; for (let i = 1; i < d.length; i++) e[i] = d[i] * k + e[i - 1] * (1 - k); return e },
                atr: (k, p) => { if (!k || k.length < p) return [0]; let t = []; for (let i = 1; i < k.length; i++) t.push(Math.max(parseFloat(k[i][2]) - parseFloat(k[i][3]), Math.abs(parseFloat(k[i][2]) - parseFloat(k[i - 1][4])), Math.abs(parseFloat(k[i][3]) - parseFloat(k[i - 1][4])))); return t.length === 0 ? [0] : TA.ema(t, p) },
                stdDev: (d, p) => { if (!d || d.length < p) return []; let s = []; for (let i = p - 1; i < d.length; i++) { const sl = d.slice(i - p + 1, i + 1), m = sl.reduce((a, b) => a + b, 0) / p; s.push(Math.sqrt(sl.map(v => Math.pow(v - m, 2)).reduce((a, b) => a + b, 0) / p)) } return s },
                adx: (k, p) => { if (!k || k.length < p * 2) return []; let h = k.map(i => parseFloat(i[2])), l = k.map(i => parseFloat(i[3])), pDM = [0], mDM = [0]; for (let i = 1; i < h.length; i++) { let u = h[i] - h[i - 1], d = l[i - 1] - l[i]; pDM.push(u > d && u > 0 ? u : 0); mDM.push(d > u && d > 0 ? d : 0) } let atr = TA.atr(k, p).slice(-pDM.length); if (atr.length === 0) return []; let spDM = TA.ema(pDM, p), smDM = TA.ema(mDM, p), pDI = [], mDI = []; for (let i = 0; i < spDM.length; i++) { pDI.push(atr[i] === 0 ? 0 : 100 * (spDM[i] / atr[i])); mDI.push(atr[i] === 0 ? 0 : 100 * (smDM[i] / atr[i])) } let dxs = []; for (let i = 0; i < pDI.length; i++) { let den = pDI[i] + mDI[i]; dxs.push(den === 0 ? 0 : 100 * (Math.abs(pDI[i] - mDI[i]) / den)) } return TA.ema(dxs, p) }
            };
            
            function stopScanner() {
                if (state.scannerIntervalId) {
                    clearInterval(state.scannerIntervalId);
                    state.scannerIntervalId = null;
                    state.recentlyTradedSymbols = [];
                    logMessage("Công cụ quét đã dừng.");
                    updateScannerStatus("Công cụ quét đã dừng.");
                    ui.scanner.startBtn.disabled = false;
                    ui.scanner.stopBtn.disabled = true;
                }
            }

            function startScanner() {
                if (!state.apiKeysValid) {
                    logMessage('Không thể bắt đầu quét, API keys không hợp lệ.', true); return;
                }
                state.recentlyTradedSymbols = [];
                logMessage("Bắt đầu công cụ quét thị trường. Danh sách các cặp đã giao dịch gần đây đã được xóa.");
                ui.scanner.startBtn.disabled = true;
                ui.scanner.stopBtn.disabled = false;
                executeScan();
                state.scannerIntervalId = setInterval(executeScan, CONSTANTS.SCANNER_INTERVAL_MS);
            }

            async function executeAutoTrades(plans) {
                if (!state.autoTradeEnabled || plans.length === 0) return;
                logMessage(`[Auto-Trade] Phát hiện ${plans.length} kế hoạch. Bắt đầu kiểm tra để thực thi...`);
                for (const plan of plans) {
                    if (state.recentlyTradedSymbols.includes(plan.symbol)) {
                        logMessage(`[Auto-Trade] Bỏ qua ${plan.symbol} vì đã được giao dịch gần đây.`);
                        continue;
                    }
                    logMessage(`[Auto-Trade] Chuẩn bị thực thi kế hoạch cho ${plan.symbol} với vốn ${plan.allocationUSD} USDT.`);
                    const orderParams = {
                        category: 'spot', symbol: plan.symbol, side: 'Buy',
                        orderType: 'Market', qty: plan.allocationUSD, marketUnit: 'quoteCoin'
                    };
                    const result = await placeOrder(orderParams);
                    if (result && result.orderId) {
                        logMessage(`[Auto-Trade] Giao dịch thành công cho ${plan.symbol}. Thêm vào danh sách đã giao dịch.`);
                        state.recentlyTradedSymbols.push(plan.symbol);
                    } else {
                        logMessage(`[Auto-Trade] Giao dịch cho ${plan.symbol} thất bại. Sẽ thử lại trong lần quét sau.`, true);
                    }
                }
            }

            async function executeScan() {
                if (state.isScanning) return;
                state.isScanning = true;
                logMessage(`[Scanner] Bắt đầu quét với thuật toán V3.4.0...`);
                try {
                    updateScannerStatus(`(B0) Lấy danh sách cặp giao dịch...`); showLoader(ui.scanner.status.textContent);
                    const instrumentsInfo = await bybitRequest('/v5/market/instruments-info', 'GET', { category: 'spot' }, true);
                    if (!instrumentsInfo?.list) throw new Error("Không thể lấy danh sách cặp giao dịch.");
                    const allTradablePairs = instrumentsInfo.list.filter(i => i.status === 'Trading' && i.quoteCoin === 'USDT').map(i => i.symbol);
                    logMessage(`[Scanner] Tìm thấy ${allTradablePairs.length} cặp SPOT USDT.`);

                    updateScannerStatus(`(B1) Lọc theo thanh khoản...`); showLoader(ui.scanner.status.textContent);
                    const allTickersData = await bybitRequest('/v5/market/tickers', 'GET', { category: 'spot' }, true);
                    if (!allTickersData?.list) throw new Error("Không thể lấy dữ liệu tickers.");
                    let universe = allTickersData.list.filter(t => allTradablePairs.includes(t.symbol) && parseFloat(t.turnover24h) > CONFIG.MIN_TURNOVER_24H);
                    logMessage(`[Scanner] ${universe.length} cặp đủ thanh khoản được đưa vào phân tích.`);

                    updateScannerStatus(`(B2+3) Lấy Order Book & Klines cho ${universe.length} cặp...`); showLoader(ui.scanner.status.textContent);
                    const dataPromises = universe.map(t => Promise.all([
                        bybitRequest('/v5/market/orderbook', 'GET', { category: 'spot', symbol: t.symbol, limit: 1 }, true),
                        bybitRequest('/v5/market/kline', 'GET', { category: 'spot', symbol: t.symbol, interval: CONFIG.KLINE_INTERVAL, limit: CONFIG.KLINE_LIMIT }, true)
                    ]));
                    const results = await Promise.all(dataPromises);
                    let candidates = [];
                    for (let i = 0; i < universe.length; i++) {
                        const [ob, klineData] = results[i]; const ticker = universe[i];
                        if (ob && klineData?.list?.length >= CONFIG.MIN_KLINE_LENGTH) {
                            const bid = ob?.b?.[0]?.[0] ?? ticker.bid1Price;
                            const ask = ob?.a?.[0]?.[0] ?? ticker.ask1Price;
                            const spreadBps = ((ask-bid)/ask)*10000;
                            const klines = klineData.list.reverse();
                            const closes = klines.map(k => parseFloat(k[4]));
                            const lastPrice = closes[closes.length - 1];
                            const lastAtr = TA.atr(klines, 14).pop() || 0;
                            const atrPct = lastPrice > 0 ? (lastAtr / lastPrice) * 100 : 0;
                            candidates.push({ ...ticker, spread_bps: spreadBps, klines, atrPct, lastAtr, _bid: bid, _ask: ask });
                        }
                    }
                    if (candidates.length === 0) throw new Error("Không có cặp nào có đủ dữ liệu kline.");
                    logMessage(`[Scanner] ${candidates.length} cặp có đủ dữ liệu để chấm điểm.`);

                    const allSpreads = candidates.map(c => c.spread_bps).filter(s => isFinite(s)).sort((a,b) => a-b);
                    const p60Spread = allSpreads[Math.floor(0.60 * allSpreads.length)];
                    const dynamicSpreadMax = Math.max(CONFIG.SPREAD_BPS_MIN, Math.min(p60Spread, CONFIG.SPREAD_BPS_MAX));
                    logMessage(`[Scanner] Ngưỡng Spread Động (P60): ${dynamicSpreadMax.toFixed(2)} bps`);

                    const atrPercentiles = candidates.map(p => p.atrPct).sort((a,b)=>a-b);
                    const p40Atr = atrPercentiles[Math.floor(atrPercentiles.length*0.4)];
                    const p95Atr = atrPercentiles[Math.floor(atrPercentiles.length*0.95)];
                    const dynamicAtrMin = Math.max(p40Atr, CONFIG.ATR_PCT_MIN_BASE);
                    const dynamicAtrMax = Math.min(p95Atr, CONFIG.ATR_PCT_MAX_BASE);
                    logMessage(`[Scanner] Ngưỡng ATR động: [${dynamicAtrMin.toFixed(2)}%, ${dynamicAtrMax.toFixed(2)}%]`);

                    updateScannerStatus(`(B4) Chấm điểm ${candidates.length} cặp...`); showLoader(ui.scanner.status.textContent);
                    let processedCandidates = [];
                    for (const cand of candidates) {
                        if (cand.atrPct < dynamicAtrMin || cand.atrPct > dynamicAtrMax) continue;
                        if (cand.spread_bps > dynamicSpreadMax) continue;
                        const closes = cand.klines.map(k => parseFloat(k[4]));
                        const adx = TA.adx(cand.klines, 14).pop() || 0;
                        const sma20 = closes.slice(-20).reduce((a,b) => a+b, 0) / 20;
                        const stdDev = TA.stdDev(closes, 20).pop() || 0;
                        const bbWidth = sma20 > 0 ? (4 * stdDev) / sma20 : 0;
                        let regime = "Range";
                        if (adx >= CONFIG.ADX_TREND_THRESHOLD) regime = "Trend";
                        if (bbWidth < CONFIG.BBW_SQUEEZE_THRESHOLD && regime !== 'Trend') regime = "Squeeze";
                        const roc15m = closes.length > 1 ? (closes[closes.length-1] / closes[closes.length-2] - 1) * 100 : 0;
                        const ema20 = TA.ema(closes, 20).pop() || 0;
                        const ema50 = TA.ema(closes, 50).pop() || 0;
                        let s_trend = 0.5 * roc15m + 0.3 * (ema20 > ema50 ? 1 : -1) - 0.2 * (cand.spread_bps / 20);
                        let s_range = cand.lastAtr > 0 ? 0.5 * (Math.abs(closes[closes.length-1] - sma20) / cand.lastAtr) - 0.3 * bbWidth - 0.2 * (cand.spread_bps / 20) : -1;
                        let s_squeeze = -0.5 * bbWidth + 0.3 * roc15m - 0.2 * (cand.spread_bps / 20);
                        const raos = 0.5 * s_range + 0.3 * s_squeeze + 0.2 * s_trend;
                        processedCandidates.push({ ...cand, raos, regime });
                    }
                    processedCandidates.sort((a, b) => b.raos - a.raos);
                    
                    const topPicks = processedCandidates.slice(0, 3);
                    const finalPlans = generateTradingPlans(topPicks);
                    displayScanResults(finalPlans);
                    logMessage(`[Scanner] Quét hoàn tất. Hiển thị ${finalPlans.length} kế hoạch giao dịch.`);
                    updateScannerStatus(`Quét xong. Cập nhật lần cuối: ${new Date().toLocaleTimeString()}`);
                    
                    await executeAutoTrades(finalPlans);
                
                } catch (error) {
                    logMessage(`[Scanner] Lỗi: ${error.message}`, true);
                    updateScannerStatus("Đã xảy ra lỗi. Kiểm tra log và thử lại.");
                    displayScanResults([]);
                } finally {
                    state.isScanning = false;
                    hideLoader();
                }
            }
            
             function generateTradingPlans(picks) {
                const totalCapital = parseFloat(ui.scanner.capital.value) || 100;
                return picks.map((c, i) => {
                    let plan = {};
                    const regimeCoeff = CONFIG.EDGE_COEFFICIENTS[c.regime.toLowerCase()] || CONFIG.EDGE_COEFFICIENTS.range;
                    switch(c.regime) {
                        case "Squeeze":
                            plan = { entry: "Buy-Stop tại Donchian20 High + buffer", SL: `entry - 0.9 * ATR`, TP1: `+${regimeCoeff.tp1ATR} * ATR`, TP2: `+${regimeCoeff.tp2ATR} * ATR` }; break;
                        case "Range":
                            plan = { entry: "Limit gần VWAP - 0.6 * ATR", SL: `-1.0 * ATR`, TP1: `+${regimeCoeff.tp1ATR} * ATR`, TP2: `+${regimeCoeff.tp2ATR} * ATR` }; break;
                        case "Trend":
                            plan = { entry: "Buy-stop trên EMA20", SL: `-0.9 * ATR`, TP1: `+${regimeCoeff.tp1ATR} * ATR`, TP2: `+${regimeCoeff.tp2ATR} * ATR` }; break;
                    }
                    return { ...c, plan, allocationUSD: (totalCapital * CONFIG.CAPITAL_ALLOCATION_PCT[i]).toFixed(2) };
                });
            }

            function displayScanResults(results) {
                ui.scanner.results.innerHTML = '';
                if (!results || results.length === 0) {
                    ui.scanner.results.innerHTML = '<p class="text-center text-gray-400 col-span-full">Không có kế hoạch giao dịch nào phù hợp. Thị trường có thể đang rất yên tĩnh.</p>';
                    return;
                }
                results.forEach(item => {
                    const regimeClass = { 'Trend':'regime-trend', 'Range':'regime-range', 'Squeeze':'regime-squeeze' }[item.regime] || 'regime-none';
                    const cardHTML = `
                        <div class="bg-gray-900/50 rounded-xl p-4 border border-gray-700 flex flex-col space-y-3">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-bold text-cyan-400">${item.symbol}</h3>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${regimeClass}">${item.regime}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-x-4 text-sm">
                                <span class="text-gray-400">RAOS</span><span class="font-semibold text-yellow-400 text-right">${item.raos?.toFixed(3) ?? 'N/A'}</span>
                                <span class="text-gray-400">ATR %</span><span class="font-semibold text-white text-right">${item.atrPct?.toFixed(2) ?? 'N/A'}%</span>
                                <span class="text-gray-400">Spread</span><span class="font-semibold text-white text-right">${item.spread_bps?.toFixed(2) ?? 'N/A'} bps</span>
                                <span class="text-gray-400">Vốn Phân Bổ</span><span class="font-bold text-white text-right">$${item.allocationUSD}</span>
                            </div>
                            <div class="border-t border-gray-700 pt-3 space-y-2 text-xs">
                                <p class="font-semibold text-gray-300">Kế hoạch Lệnh:</p>
                                <p><strong class="text-green-400">Entry:</strong> ${item.plan.entry}</p>
                                <p><strong class="text-red-400">Stop Loss:</strong> ${item.plan.SL}</p>
                                <p><strong class="text-blue-400">Take Profit:</strong> ${item.plan.TP1} (TP1) / ${item.plan.TP2} (TP2)</p>
                                <p><strong class="text-purple-400">Quản Trị:</strong> Dời SL về hòa vốn khi chạm TP1.</p>
                            </div>
                            <div class="border-t border-gray-700 pt-3 space-y-2 text-xs">
                                 <p class="font-semibold text-gray-300">Check-list An Toàn:</p>
                                 <ul class="list-disc list-inside text-gray-400">
                                     <li>Xác nhận Volume tăng đột biến khi phá vỡ.</li>
                                     <li>Tránh vào lệnh khi có râu nến dài (wick).</li>
                                     <li>Chi phí giao dịch (spread) hợp lý.</li>
                                 </ul>
                            </div>
                        </div>`;
                    ui.scanner.results.innerHTML += cardHTML;
                });
            }

            // --- Event Listeners ---
            ui.saveApiBtn.addEventListener('click', () => {
                state.apiKey = ui.apiKeyInput.value.trim();
                state.apiSecret = ui.apiSecretInput.value.trim();
                if (state.apiKey && state.apiSecret) {
                    localStorage.setItem('bybitApiKey', state.apiKey);
                    localStorage.setItem('bybitApiSecret', state.apiSecret);
                    logMessage('API Key và Secret đã được lưu. Đang xác thực...');
                    checkApiKeys();
                } else {
                    logMessage('Vui lòng nhập cả API Key và Secret.', true);
                }
            });

            ui.showApiKeysCheckbox.addEventListener('change', (e) => {
                const type = e.target.checked ? 'text' : 'password';
                ui.apiKeyInput.type = type;
                ui.apiSecretInput.type = type;
            });
            
            ui.getBalanceBtn.addEventListener('click', fetchWalletBalance);
            ui.buyBtn.addEventListener('click', () => placeOrder({ category: 'spot', symbol: ui.symbolInput.value.trim().toUpperCase(), side: 'Buy', orderType: 'Market', qty: ui.qtyInput.value.trim() }));
            ui.sellBtn.addEventListener('click', () => placeOrder({ category: 'spot', symbol: ui.symbolInput.value.trim().toUpperCase(), side: 'Sell', orderType: 'Market', qty: ui.qtyInput.value.trim() }));
            
            ui.dca.startBtn.addEventListener('click', startDcaBot);
            ui.dca.stopBtn.addEventListener('click', stopDcaBot);

            ui.scanner.startBtn.addEventListener('click', startScanner);
            ui.scanner.stopBtn.addEventListener('click', stopScanner);
            
            ui.scanner.autoTradeToggle.addEventListener('change', (e) => {
                state.autoTradeEnabled = e.target.checked;
                if (state.autoTradeEnabled) {
                    logMessage('[Auto-Trade] Tự động giao dịch đã được BẬT. Các tín hiệu hợp lệ SẼ được thực thi.', false);
                } else {
                    logMessage('[Auto-Trade] Tự động giao dịch đã được TẮT.', false);
                }
            });

            // --- Initialization ---
            function initialize() {
                loadAndCheckApiKeys();
                logMessage('Bot đã sẵn sàng. Vui lòng lưu API key để kích hoạt các tính năng.');
            }

            initialize();
        });
    </script>
</body>
</html>

