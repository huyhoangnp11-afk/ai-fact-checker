<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit Trading Bot</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CryptoJS for API signature generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .log-area { font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-break: break-all; }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .regime-trend { background-color: #166534; color: #dcfce7; }
        .regime-range { background-color: #1e40af; color: #dbeafe; }
        .regime-squeeze { background-color: #9a3412; color: #ffedd5; }
        .regime-micro-grid { background-color: #581c87; color: #f3e8ff; }
        .regime-none { background-color: #4b5563; color: #d1d5db; }
        .toggle-checkbox:checked { right: 0; border-color: #68d391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68d391; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-7xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        
        <header class="text-center">
            <h1 class="text-3xl font-bold text-white">Bybit Trading Bot</h1>
            <p class="text-gray-400 mt-2">Giao dịch tự động và quản lý tài khoản Bybit của bạn.</p>
        </header>

        <!-- Security Warning -->
        <div class="bg-red-900 border-l-4 border-red-500 text-red-100 p-4 rounded-lg" role="alert">
            <p class="font-bold">Cảnh báo bảo mật quan trọng</p>
            <p>API Key và Secret Key của bạn chỉ được lưu trữ cục bộ trong trình duyệt. Bot không lưu lại trạng thái giao dịch khi bạn tải lại trang.</p>
        </div>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Left Column: Settings & Account -->
            <div class="bg-gray-700/50 p-6 rounded-xl space-y-6">
                 <div class="flex items-center justify-between border-b border-gray-600 pb-3">
                    <h2 class="text-xl font-semibold">Cài đặt API</h2>
                    <span id="apiStatus" class="text-xs font-medium px-2.5 py-1 rounded-full">&nbsp;</span>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-300 mb-1">API Key</label>
                        <input type="password" id="apiKey" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="apiSecret" class="block text-sm font-medium text-gray-300 mb-1">API Secret</label>
                        <input type="password" id="apiSecret" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                     <div class="flex items-center justify-between">
                        <button id="saveApi" class="w-2/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">Lưu API Key</button>
                        <div class="flex items-center space-x-2 text-sm">
                           <label for="showApiKeys" class="text-gray-400">Hiện Keys</label>
                           <input type="checkbox" id="showApiKeys" class="form-checkbox h-5 w-5 text-blue-500 bg-gray-900 border-gray-600 rounded focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div class="pt-6 border-t border-gray-600">
                    <h2 class="text-xl font-semibold mb-3">Thông tin tài khoản</h2>
                    <button id="getBalance" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition mb-4 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Lấy số dư (Tài khoản Unified)</button>
                    <div id="balanceInfo" class="bg-gray-900 p-4 rounded-lg text-sm min-h-[80px]">
                        Nhấn nút trên để xem số dư...
                    </div>
                </div>
            </div>

            <!-- Right Column: Trading -->
            <div class="bg-gray-700/50 p-6 rounded-xl space-y-6">
                <h2 class="text-xl font-semibold border-b border-gray-600 pb-3">Đặt lệnh giao dịch (Spot)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="symbol" class="block text-sm font-medium text-gray-300 mb-1">Cặp giao dịch (ví dụ: BTCUSDT)</label>
                        <input type="text" id="symbol" value="BTCUSDT" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="qty" class="block text-sm font-medium text-gray-300 mb-1">Số lượng</label>
                        <input type="number" id="qty" placeholder="0.01" step="0.001" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="buyBtn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Mua (Market)</button>
                        <button id="sellBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Bán (Market)</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- DCA Bot Section -->
        <div class="bg-gray-700/50 p-6 rounded-xl mt-6">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-3 mb-4">Bot DCA (Trung bình giá)</h2>
            <div class="bg-blue-900 border-l-4 border-blue-500 text-blue-100 p-4 rounded-lg mb-4" role="alert">
                <p><strong class="font-bold">Lưu ý:</strong> Bot DCA sẽ chỉ hoạt động khi tab trình duyệt này đang mở. Nếu bạn đóng tab, bot sẽ dừng lại.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="dcaSymbol" class="block text-sm font-medium text-gray-300 mb-1">Cặp giao dịch</label>
                    <input type="text" id="dcaSymbol" value="BTCUSDT" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="dcaAmount" class="block text-sm font-medium text-gray-300 mb-1">Số tiền mỗi lần mua (USDT)</label>
                    <input type="number" id="dcaAmount" placeholder="10" step="1" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="dcaFrequency" class="block text-sm font-medium text-gray-300 mb-1">Tần suất</label>
                    <select id="dcaFrequency" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="3600000">Mỗi giờ</option>
                        <option value="86400000" selected>Mỗi ngày</option>
                        <option value="604800000">Mỗi tuần</option>
                        <option value="60000">Mỗi phút (thử nghiệm)</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="startDcaBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Bắt đầu Bot DCA</button>
                <button id="stopDcaBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300" disabled>Dừng Bot DCA</button>
            </div>
            <div id="dcaStatus" class="mt-4 bg-gray-900 p-3 rounded-lg text-sm text-center">Bot DCA đang không hoạt động.</div>
        </div>

        <!-- Market Scanner Section -->
        <div class="bg-gray-700/50 p-6 rounded-xl mt-6">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-3 mb-4">Kế Hoạch Giao Dịch Tự Động (V3.6.0)</h2>
            <div class="bg-blue-900 border-l-4 border-blue-500 text-blue-100 p-4 rounded-lg mb-4" role="alert">
                <p><strong class="font-bold">Cách Hoạt Động Mới:</strong> Bot sử dụng kết hợp RSI và EMA để tránh mua đỉnh, tìm điểm vào lệnh tối ưu trong một xu hướng tăng.</p>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div class="md:col-span-1">
                    <label for="scannerCapital" class="block text-sm font-medium text-gray-300 mb-1">Vốn cho mỗi lệnh (USD)</label>
                    <input type="number" id="scannerCapital" value="8" step="1" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="takeProfitPercent" class="block text-sm font-medium text-gray-300 mb-1">Chốt Lời (%)</label>
                    <input type="number" id="takeProfitPercent" value="1.5" step="0.1" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="stopLossPercent" class="block text-sm font-medium text-gray-300 mb-1">Cắt Lỗ (%)</label>
                    <input type="number" id="stopLossPercent" value="0.8" step="0.1" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-1 flex items-end pb-1">
                     <label for="autoTradeToggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="autoTradeToggle" class="sr-only peer">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full peer-checked:bg-green-600"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform transform peer-checked:translate-x-full"></div>
                        </div>
                        <span class="ml-3 text-sm font-medium text-gray-300">Tự động Trade</span>
                    </label>
                </div>
                <div class="md:col-span-1 grid grid-cols-2 gap-2">
                    <button id="startScannerBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Bắt đầu</button>
                    <button id="stopScannerBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300" disabled>Dừng</button>
                </div>
            </div>
            <div id="scannerStatus" class="mt-4 bg-gray-900 p-3 rounded-lg text-sm text-center">Công cụ quét đang không hoạt động.</div>
            
            <!-- Trading Plan Cards Container -->
            <div id="scannerResults" class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Trading Plan Cards will be populated here -->
            </div>
        </div>

        <!-- Log Area -->
        <div class="bg-gray-900/70 p-4 rounded-xl mt-6">
            <h2 class="text-lg font-semibold mb-2">Nhật ký hoạt động</h2>
            <div id="log" class="log-area bg-black h-48 overflow-y-auto p-3 rounded-lg text-xs text-gray-400"></div>
        </div>

    </div>

    <!-- Loading Spinner Modal -->
    <div id="loaderModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
            <p id="loaderText" class="mt-4 text-white text-lg font-semibold">Đang xử lý...</p>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const ui = {
                apiKeyInput: document.getElementById('apiKey'),
                apiSecretInput: document.getElementById('apiSecret'),
                saveApiBtn: document.getElementById('saveApi'),
                showApiKeysCheckbox: document.getElementById('showApiKeys'),
                apiStatus: document.getElementById('apiStatus'),
                getBalanceBtn: document.getElementById('getBalance'),
                balanceInfoDiv: document.getElementById('balanceInfo'),
                symbolInput: document.getElementById('symbol'),
                qtyInput: document.getElementById('qty'),
                buyBtn: document.getElementById('buyBtn'),
                sellBtn: document.getElementById('sellBtn'),
                logDiv: document.getElementById('log'),
                loaderModal: document.getElementById('loaderModal'),
                loaderText: document.getElementById('loaderText'),
                dca: {
                    symbol: document.getElementById('dcaSymbol'),
                    amount: document.getElementById('dcaAmount'),
                    frequency: document.getElementById('dcaFrequency'),
                    startBtn: document.getElementById('startDcaBtn'),
                    stopBtn: document.getElementById('stopDcaBtn'),
                    status: document.getElementById('dcaStatus'),
                },
                scanner: {
                    capital: document.getElementById('scannerCapital'),
                    takeProfitInput: document.getElementById('takeProfitPercent'),
                    stopLossInput: document.getElementById('stopLossPercent'),
                    autoTradeToggle: document.getElementById('autoTradeToggle'),
                    startBtn: document.getElementById('startScannerBtn'),
                    stopBtn: document.getElementById('stopScannerBtn'),
                    status: document.getElementById('scannerStatus'),
                    results: document.getElementById('scannerResults'),
                }
            };

            // --- State Management ---
            const state = {
                apiKey: '',
                apiSecret: '',
                dcaIntervalId: null,
                scannerIntervalId: null,
                isScanning: false,
                apiKeysValid: false,
                autoTradeEnabled: false,
                activeTrade: null, // Holds { symbol, entryPrice, quantity, intervalId }
            };

            // --- Constants & Config ---
            const CONSTANTS = {
                BYBIT_API_URL: 'https://api.bybit.com',
                RECV_WINDOW: '10000', 
                SCANNER_INTERVAL_MS: 120000, 
                TRADE_MONITOR_INTERVAL_MS: 7000,
            };
            const CONFIG = {
                MIN_ORDER_VALUE_USDT: 3, 
                MIN_TURNOVER_24H: 500000,
            };
            
             // --- Technical Analysis Lib ---
            const TA = {
                ema: (d, p) => {
                    if (!d || d.length < p) return [];
                    const k = 2 / (p + 1);
                    let e = [d[0]];
                    for (let i = 1; i < d.length; i++) e[i] = d[i] * k + e[i - 1] * (1 - k);
                    return e;
                },
                rsi: (d, p) => {
                    if (!d || d.length < p + 1) return [];
                    let gains = 0, losses = 0;
                    for (let i = 1; i <= p; i++) {
                        const diff = d[i] - d[i - 1];
                        if (diff > 0) gains += diff;
                        else losses -= diff;
                    }
                    let avgGain = gains / p;
                    let avgLoss = losses / p;
                    if (avgLoss === 0) return Array(d.length - p).fill(100);

                    let rsiValues = [100 - (100 / (1 + (avgGain / avgLoss)))];

                    for (let i = p + 1; i < d.length; i++) {
                        const diff = d[i] - d[i - 1];
                        let gain = 0, loss = 0;
                        if (diff > 0) gain = diff;
                        else loss = -diff;
                        avgGain = (avgGain * (p - 1) + gain) / p;
                        avgLoss = (avgLoss * (p - 1) + loss) / p;
                        if (avgLoss === 0) {
                           rsiValues.push(100);
                        } else {
                           rsiValues.push(100 - (100 / (1 + (avgGain / avgLoss))));
                        }
                    }
                    return rsiValues;
                }
            };

            // --- Core Functions ---
            const showLoader = (text = 'Đang xử lý...') => {
                ui.loaderText.textContent = text;
                ui.loaderModal.classList.remove('hidden');
            };
            const hideLoader = () => ui.loaderModal.classList.add('hidden');

            function logMessage(message, isError = false) {
                const timestamp = new Date().toLocaleString();
                const colorClass = isError ? 'text-red-400' : 'text-green-400';
                ui.logDiv.innerHTML += `<p class="${colorClass}">[${timestamp}] ${message}</p>`;
                ui.logDiv.scrollTop = ui.logDiv.scrollHeight;
            }

            async function getServerTimestampMs() {
                try {
                    const r = await fetch(`${CONSTANTS.BYBIT_API_URL}/v5/market/time`);
                    const j = await r.json();
                    if (j.retCode !== 0) throw new Error("Could not sync Bybit server time.");
                    const nsStr = j.result?.timeNano;
                    return nsStr ? (BigInt(nsStr) / 1000000n).toString() : (BigInt(j.result.timeSecond) * 1000n).toString();
                } catch (e) {
                    return Date.now().toString();
                }
            }
            
            async function bybitRequest(endpoint, method, params = {}, isPublic = false) {
                const isValidationCall = endpoint === '/v5/user/query-api';
                if (!isPublic && !state.apiKeysValid && !isValidationCall) {
                    if (endpoint.includes('/v5/market/tickers')) return null;
                    logMessage('API Keys không hợp lệ hoặc chưa được lưu.', true);
                    return null;
                }
                const headers = { 'Content-Type': 'application/json' };
                let url = `${CONSTANTS.BYBIT_API_URL}${endpoint}`;
                let body;

                if (!isPublic) {
                    const timestamp = await getServerTimestampMs();
                    const paramStr = method === 'POST' ? JSON.stringify(params) : new URLSearchParams(params).toString();
                    const signStr = timestamp + state.apiKey + CONSTANTS.RECV_WINDOW + paramStr;
                    const signature = CryptoJS.HmacSHA256(signStr, state.apiSecret).toString(CryptoJS.enc.Hex);
                    Object.assign(headers, {
                        'X-BAPI-API-KEY': state.apiKey, 'X-BAPI-TIMESTAMP': timestamp,
                        'X-BAPI-RECV-WINDOW': CONSTANTS.RECV_WINDOW, 'X-BAPI-SIGN': signature,
                    });
                    if (method === 'GET' && paramStr) url += `?${paramStr}`;
                    if (method === 'POST') body = paramStr;
                } else {
                     if (Object.keys(params).length > 0) url += `?${new URLSearchParams(params)}`;
                }
                try {
                    const response = await fetch(url, { method, headers, body });
                    const data = await response.json();
                    if (data.retCode !== 0) {
                        if (data.retMsg.includes("Not supported symbols") || data.retMsg.includes("Instrument not found")) return null;
                        throw new Error(`Bybit API Error: ${data.retMsg} (Code: ${data.retCode})`);
                    }
                    return data.result;
                } catch (error) {
                    if (!isValidationCall) { 
                        logMessage(error.message, true);
                    }
                    return null;
                }
            }
            
            async function placeOrder(orderParams) {
                if (!orderParams.symbol || !orderParams.qty) {
                    logMessage('Thông tin lệnh không hợp lệ.', true); return null;
                }
                const result = await bybitRequest('/v5/order/create', 'POST', orderParams);
                if (result?.orderId) {
                    logMessage(`Đặt lệnh ${orderParams.side} ${orderParams.symbol} thành công! Order ID: ${result.orderId}`);
                    // Fetch order details to get accurate entry price and quantity
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Wait for order to fill
                    const orderHistory = await bybitRequest('/v5/order/history', 'GET', { category: 'spot', orderId: result.orderId });
                    return orderHistory?.list?.[0] ?? result;
                }
                return null;
            }

            function updateApiStatus(isValid) {
                state.apiKeysValid = isValid;
                const activeClasses = 'bg-green-900 text-green-300';
                const inactiveClasses = 'bg-red-900 text-red-300';
                ui.apiStatus.textContent = isValid ? 'Hợp lệ' : 'Không hợp lệ';
                ui.apiStatus.className = `text-xs font-medium px-2.5 py-1 rounded-full ${isValid ? activeClasses : inactiveClasses}`;
                [ui.getBalanceBtn, ui.buyBtn, ui.sellBtn, ui.dca.startBtn, ui.scanner.startBtn].forEach(btn => btn.disabled = !isValid);
            }

            async function checkApiKeys() {
                if (!state.apiKey || !state.apiSecret) {
                    updateApiStatus(false); return;
                }
                const result = await bybitRequest('/v5/user/query-api', 'GET', {});
                updateApiStatus(!!result);
                logMessage(!!result ? 'Xác thực API Key thành công.' : 'API Keys không hợp lệ.', !result);
            }
            
            // --- Trade Management ---

            async function closeActiveTrade(reason) {
                if (!state.activeTrade) return;

                const tradeToClose = { ...state.activeTrade }; 
                state.activeTrade = null; 
                clearInterval(tradeToClose.intervalId);

                logMessage(`[Trade Manager] Đóng lệnh ${tradeToClose.symbol} vì: ${reason}.`, false);
                
                const orderParams = {
                    category: 'spot',
                    symbol: tradeToClose.symbol,
                    side: 'Sell',
                    orderType: 'Market',
                    qty: tradeToClose.quantity.toString(),
                };

                const sellResult = await placeOrder(orderParams);
                if (sellResult && sellResult.orderId) {
                    const entryValue = parseFloat(tradeToClose.entryValue);
                    const exitValue = parseFloat(sellResult.cumExecValue);
                    const profit = (exitValue - entryValue).toFixed(2);
                    logMessage(`[Trade Manager] Bán thành công ${tradeToClose.quantity} ${tradeToClose.symbol}. Lợi nhuận ước tính: ${profit} USDT.`);
                    logMessage("Bot đã sẵn sàng tìm kiếm tín hiệu giao dịch tiếp theo.", false);
                    await fetchWalletBalance();
                } else {
                    logMessage(`[Trade Manager] LỖI NGHIÊM TRỌNG: Không thể đặt lệnh bán cho ${tradeToClose.symbol}. Cần can thiệp thủ công!`, true);
                }
            }

            function startTradeMonitor() {
                if (!state.activeTrade) return;

                const tpPercent = parseFloat(ui.scanner.takeProfitInput.value) / 100;
                const slPercent = parseFloat(ui.scanner.stopLossInput.value) / 100;
                
                if (isNaN(tpPercent) || isNaN(slPercent) || tpPercent <= 0 || slPercent <= 0) {
                     logMessage('[Trade Manager] Lỗi: Tỷ lệ TP/SL không hợp lệ. Giao dịch sẽ không được quản lý.', true);
                     state.activeTrade = null; 
                     return;
                }

                const { symbol, entryPrice } = state.activeTrade;
                const tpPrice = entryPrice * (1 + tpPercent);
                const slPrice = entryPrice * (1 - slPercent);

                logMessage(`[Trade Manager] Bắt đầu giám sát ${symbol}. Entry: ${entryPrice.toFixed(4)}, TP: ${tpPrice.toFixed(4)}, SL: ${slPrice.toFixed(4)}.`);
                
                const intervalId = setInterval(async () => {
                    if (!state.activeTrade || state.activeTrade.symbol !== symbol) {
                        clearInterval(intervalId);
                        return;
                    }
                    const tickerData = await bybitRequest('/v5/market/tickers', 'GET', { category: 'spot', symbol }, true);
                    if (tickerData?.list?.[0]) {
                        const currentPrice = parseFloat(tickerData.list[0].lastPrice);
                        updateScannerStatus(`Đang giám sát ${symbol}: ${currentPrice.toFixed(4)}`);
                        if (currentPrice >= tpPrice) {
                            closeActiveTrade(`Đạt Take Profit tại ${currentPrice.toFixed(4)}`);
                        } else if (currentPrice <= slPrice) {
                            closeActiveTrade(`Chạm Stop Loss tại ${currentPrice.toFixed(4)}`);
                        }
                    }
                }, CONSTANTS.TRADE_MONITOR_INTERVAL_MS);

                state.activeTrade.intervalId = intervalId;
            }

            // --- Auto Trade Execution ---
            async function executeAutoTrades(plans) {
                if (!state.autoTradeEnabled || plans.length === 0 || state.activeTrade) {
                    if (state.activeTrade) {
                         updateScannerStatus(`Đang trong giao dịch ${state.activeTrade.symbol}. Tạm dừng quét.`);
                    }
                    return;
                }

                const capital = parseFloat(ui.scanner.capital.value);
                if (capital < CONFIG.MIN_ORDER_VALUE_USDT) {
                    logMessage(`[Auto-Trade] Vốn ${capital} USDT quá thấp, yêu cầu tối thiểu ${CONFIG.MIN_ORDER_VALUE_USDT} USDT.`, true);
                    return;
                }

                logMessage("[Auto-Trade] Bắt đầu thực thi chiến lược 'Ưu tiên tín hiệu tốt nhất'.");

                for (const plan of plans) {
                    logMessage(`[Auto-Trade] Thử vào lệnh cho tín hiệu #1: ${plan.symbol} với ${capital} USDT.`);
                    const orderParams = {
                        category: 'spot', symbol: plan.symbol, side: 'Buy',
                        orderType: 'Market', qty: capital.toString(), marketUnit: 'quoteCoin'
                    };
                    const result = await placeOrder(orderParams);

                    if (result && result.orderId && result.cumExecQty && parseFloat(result.cumExecQty) > 0) {
                        logMessage(`[Auto-Trade] VÀO LỆNH THÀNH CÔNG cho ${plan.symbol}.`);
                        state.activeTrade = {
                            symbol: plan.symbol,
                            entryPrice: parseFloat(result.avgPrice),
                            quantity: parseFloat(result.cumExecQty),
                            entryValue: parseFloat(result.cumExecValue),
                            intervalId: null,
                        };
                        startTradeMonitor();
                        return; // Exit after one successful trade
                    } else {
                        logMessage(`[Auto-Trade] Lệnh cho ${plan.symbol} thất bại hoặc không khớp. Thử tín hiệu tiếp theo...`, true);
                    }
                }
                logMessage(`[Auto-Trade] Đã thử tất cả ${plans.length} tín hiệu nhưng không có giao dịch nào thành công.`, true);
            }
            
            // --- UI Handlers & Initialization ---
            function setupEventListeners() {
                ui.saveApiBtn.addEventListener('click', () => {
                    state.apiKey = ui.apiKeyInput.value.trim();
                    state.apiSecret = ui.apiSecretInput.value.trim();
                    if (state.apiKey && state.apiSecret) {
                        localStorage.setItem('bybitApiKey', state.apiKey);
                        localStorage.setItem('bybitApiSecret', state.apiSecret);
                        logMessage('API Key và Secret đã được lưu. Đang xác thực...');
                        checkApiKeys();
                    } else { logMessage('Vui lòng nhập cả API Key và Secret.', true); }
                });

                ui.showApiKeysCheckbox.addEventListener('change', (e) => {
                    const type = e.target.checked ? 'text' : 'password';
                    ui.apiKeyInput.type = type;
                    ui.apiSecretInput.type = type;
                });
                
                ui.getBalanceBtn.addEventListener('click', fetchWalletBalance);
                ui.buyBtn.addEventListener('click', () => placeOrder({ category: 'spot', symbol: ui.symbolInput.value.trim().toUpperCase(), side: 'Buy', orderType: 'Market', qty: ui.qtyInput.value.trim() }));
                ui.sellBtn.addEventListener('click', () => placeOrder({ category: 'spot', symbol: ui.symbolInput.value.trim().toUpperCase(), side: 'Sell', orderType: 'Market', qty: ui.qtyInput.value.trim() }));
                
                ui.dca.startBtn.addEventListener('click', startDcaBot);
                ui.dca.stopBtn.addEventListener('click', stopDcaBot);

                ui.scanner.startBtn.addEventListener('click', startScanner);
                ui.scanner.stopBtn.addEventListener('click', stopScanner);
                
                ui.scanner.autoTradeToggle.addEventListener('change', (e) => {
                    state.autoTradeEnabled = e.target.checked;
                    logMessage(`[Auto-Trade] Tự động giao dịch đã được ${state.autoTradeEnabled ? 'BẬT' : 'TẮT'}.`);
                });
            }

            function initialize() {
                const storedApiKey = localStorage.getItem('bybitApiKey');
                const storedApiSecret = localStorage.getItem('bybitApiSecret');
                if(storedApiKey && storedApiSecret) {
                    ui.apiKeyInput.value = storedApiKey;
                    ui.apiSecretInput.value = storedApiSecret;
                    state.apiKey = storedApiKey;
                    state.apiSecret = storedApiSecret;
                    checkApiKeys();
                } else {
                    updateApiStatus(false);
                }
                setupEventListeners();
                logMessage('Bot đã sẵn sàng. Vui lòng lưu API key để kích hoạt các tính năng.');
            }
            
             // --- Scanner Logic ---
            async function executeScan() {
                if (state.isScanning || state.activeTrade) return;
                state.isScanning = true;
                logMessage(`[Scanner] Bắt đầu quét với thuật toán V3.6.0...`);
                try {
                    updateScannerStatus(`(B0) Lấy danh sách cặp giao dịch...`); showLoader(ui.scanner.status.textContent);
                    const instrumentsInfo = await bybitRequest('/v5/market/instruments-info', 'GET', { category: 'spot' }, true);
                    const allTradablePairs = instrumentsInfo.list.filter(i => i.status === 'Trading' && i.quoteCoin === 'USDT').map(i => i.symbol);

                    updateScannerStatus(`(B1) Lọc theo thanh khoản...`); showLoader(ui.scanner.status.textContent);
                    const allTickersData = await bybitRequest('/v5/market/tickers', 'GET', { category: 'spot' }, true);
                    let universe = allTickersData.list.filter(t => allTradablePairs.includes(t.symbol) && parseFloat(t.turnover24h) > CONFIG.MIN_TURNOVER_24H);

                    updateScannerStatus(`(B2+3) Lấy dữ liệu chi tiết cho ${universe.length} cặp...`); showLoader(ui.scanner.status.textContent);
                    const dataPromises = universe.map(t => Promise.all([
                        bybitRequest('/v5/market/orderbook', 'GET', { category: 'spot', symbol: t.symbol, limit: 1 }, true),
                        bybitRequest('/v5/market/kline', 'GET', { category: 'spot', symbol: t.symbol, interval: '15', limit: 200 }, true)
                    ]));
                    const results = await Promise.all(dataPromises);
                    let candidates = [];
                     for (let i = 0; i < universe.length; i++) {
                        const [ob, klineData] = results[i];
                        if (ob && klineData?.list?.length >= 51) {
                            const ticker = universe[i];
                            const ask = ob?.a?.[0]?.[0] ?? ticker.ask1Price;
                            const bid = ob?.b?.[0]?.[0] ?? ticker.bid1Price;
                            candidates.push({ ...ticker, spread_bps: ((ask - bid) / ask) * 10000, klines: klineData.list.reverse() });
                        }
                    }
                    
                    updateScannerStatus(`(B4) Chấm điểm ${candidates.length} cặp với logic EMA/RSI...`); showLoader(ui.scanner.status.textContent);
                    let processedCandidates = [];
                    for (const cand of candidates) {
                        const closes = cand.klines.map(k => parseFloat(k[4]));
                        const lastPrice = closes[closes.length - 1];
                        if (!lastPrice || closes.length < 51) continue; 

                        const ema20 = TA.ema(closes, 20).pop();
                        const ema50 = TA.ema(closes, 50).pop();
                        const rsi14 = TA.rsi(closes, 14).pop();
                        
                        if (ema20 === undefined || ema50 === undefined || rsi14 === undefined) continue;

                        const isUptrend = ema20 > ema50;
                        const priceAboveTrend = lastPrice > ema50;
                        const notOverbought = rsi14 < 75; 
                        const notOversold = rsi14 > 40; 

                        if (isUptrend && priceAboveTrend && notOverbought && notOversold) {
                            const rsiScore = (75 - rsi14) / 35; 
                            const proximityToEmaScore = 1 - Math.min(1, Math.abs(lastPrice - ema20) / lastPrice * 10);
                            const spreadScore = 1 - Math.min(1, cand.spread_bps / 30);
                            const finalScore = (rsiScore * 0.4) + (proximityToEmaScore * 0.4) + (spreadScore * 0.2);

                            processedCandidates.push({ ...cand, raos: finalScore, regime: 'Uptrend Pullback', rsi: rsi14 });
                        }
                    }
                    processedCandidates.sort((a, b) => b.raos - a.raos);
                    
                    const topPicks = processedCandidates.slice(0, 3);
                    displayScanResults(topPicks);
                    logMessage(`[Scanner] Quét hoàn tất. Hiển thị ${topPicks.length} kế hoạch giao dịch.`);
                    updateScannerStatus(`Quét xong. Cập nhật lần cuối: ${new Date().toLocaleTimeString()}`);
                    
                    await executeAutoTrades(topPicks);
                
                } catch (error) {
                    logMessage(`[Scanner] Lỗi: ${error.message}`, true);
                    updateScannerStatus("Đã xảy ra lỗi. Kiểm tra log và thử lại.");
                    displayScanResults([]);
                } finally {
                    state.isScanning = false;
                    hideLoader();
                }
            }

            function displayScanResults(results) {
                 ui.scanner.results.innerHTML = '';
                if (!results || results.length === 0) {
                    ui.scanner.results.innerHTML = '<p class="text-center text-gray-400 col-span-full">Không có kế hoạch giao dịch nào phù hợp.</p>';
                    return;
                }
                const totalCapital = parseFloat(ui.scanner.capital.value) || 8;
                results.forEach((item, index) => {
                    const capitalDisplay = index === 0 ? `$${totalCapital.toFixed(2)} (Ưu tiên #1)` : 'Dự phòng';
                    const cardHTML = `
                        <div class="bg-gray-900/50 rounded-xl p-4 border border-gray-700 flex flex-col space-y-3 ${index > 0 ? 'opacity-60' : ''}">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-bold text-cyan-400">${item.symbol}</h3>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full regime-trend">${item.regime}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-x-4 text-sm">
                                <span class="text-gray-400">Score</span><span class="font-semibold text-yellow-400 text-right">${item.raos?.toFixed(3) ?? 'N/A'}</span>
                                <span class="text-gray-400">RSI(14)</span><span class="font-semibold text-white text-right">${item.rsi?.toFixed(2) ?? 'N/A'}</span>
                                <span class="text-gray-400">Spread</span><span class="font-semibold text-white text-right">${item.spread_bps?.toFixed(2) ?? 'N/A'} bps</span>
                                <span class="text-gray-400">Vốn Phân Bổ</span><span class="font-bold text-white text-right">${capitalDisplay}</span>
                            </div>
                        </div>`;
                    ui.scanner.results.innerHTML += cardHTML;
                });
            }
            // --- Stubs for unused functions ---
            const startDcaBot = () => logMessage("DCA Bot is not implemented in this version.", true);
            const stopDcaBot = () => {};
            const fetchWalletBalance = async () => {
                 showLoader('Đang lấy số dư...');
                const result = await bybitRequest('/v5/account/wallet-balance', 'GET', { accountType: 'UNIFIED' });
                hideLoader();
                if (result?.list?.[0]) {
                    const account = result.list[0];
                    let balanceHTML = `<p><strong>Tổng vốn (USD):</strong> ${parseFloat(account.totalEquity).toFixed(2)}</p><p><strong>Số dư khả dụng (USD):</strong> ${parseFloat(account.totalAvailableBalance).toFixed(2)}</p><hr class="my-2 border-gray-600"><ul class="space-y-1 max-h-40 overflow-y-auto">`;
                    account.coin.forEach(c => { if (parseFloat(c.walletBalance) > 0) balanceHTML += `<li><strong>${c.coin}:</strong> ${parseFloat(c.walletBalance).toFixed(6)}</li>`; });
                    balanceHTML += '</ul>';
                    ui.balanceInfoDiv.innerHTML = balanceHTML;
                } else {
                    ui.balanceInfoDiv.textContent = "Không thể lấy dữ liệu số dư.";
                }
            };
            const startScanner = () => {
                if (!state.apiKeysValid) { logMessage('API keys không hợp lệ.', true); return; }
                if (state.scannerIntervalId || state.activeTrade) { logMessage('Bot đang bận, vui lòng dừng trước khi bắt đầu lại.', true); return; }
                logMessage("Bắt đầu công cụ quét thị trường...");
                ui.scanner.startBtn.disabled = true;
                ui.scanner.stopBtn.disabled = false;
                executeScan();
                state.scannerIntervalId = setInterval(executeScan, CONSTANTS.SCANNER_INTERVAL_MS);
            };
            const stopScanner = () => {
                if (state.scannerIntervalId) {
                    clearInterval(state.scannerIntervalId);
                    state.scannerIntervalId = null;
                    logMessage("Công cụ quét đã dừng bởi người dùng.");
                    updateScannerStatus("Công cụ quét đang không hoạt động.");
                    ui.scanner.startBtn.disabled = false;
                    ui.scanner.stopBtn.disabled = true;
                }
                 if(state.activeTrade) {
                    closeActiveTrade("Người dùng yêu cầu dừng bot.");
                }
            };

            // --- Start the application ---
            initialize();
        });
    </script>
</body>
</html>

